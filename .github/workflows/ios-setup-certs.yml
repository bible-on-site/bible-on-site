name: iOS Certificate Setup (One-Time)

# This workflow generates iOS signing certificates and provisioning profiles
# Run this ONCE to set up iOS code signing, then delete or disable this workflow

on:
  workflow_dispatch:
    inputs:
      certificate_password:
        description: 'Password for the .p12 certificate export'
        required: true
        type: string

jobs:
  generate_certificates:
    name: Generate iOS Certificates
    runs-on: macos-14

    steps:
      - name: Install Fastlane
        run: |
          gem install fastlane -NV

      - name: Generate Certificate and Profile
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          CERT_PASSWORD: ${{ inputs.certificate_password }}
        run: |
          # Decode API key
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8

          # Create Fastlane directory and config
          mkdir -p fastlane

          cat > fastlane/Appfile << EOF
          app_identifier("com.tanah.daily929")
          EOF

          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            desc "Generate certificates and provisioning profiles"
            lane :generate_certs do
              # Set up App Store Connect API
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
                key_filepath: "AuthKey.p8",
                in_house: false
              )

              # Create or get distribution certificate
              cert(
                api_key: api_key,
                generate_apple_certs: true,
                output_path: "./certs"
              )

              # Create App Store provisioning profile
              sigh(
                api_key: api_key,
                app_identifier: "com.tanah.daily929",
                output_path: "./profiles",
                force: true
              )
            end
          end
          EOF

          # Run Fastlane
          fastlane generate_certs

          # Find the generated files
          echo "=== Generated Files ==="
          ls -la certs/ || echo "No certs directory"
          ls -la profiles/ || echo "No profiles directory"

          # Get Team ID from the certificate
          CERT_FILE=$(find certs -name "*.cer" | head -1)
          if [ -n "$CERT_FILE" ]; then
            echo "Certificate found: $CERT_FILE"
          fi

          # Find private key and certificate
          CERT_ID=$(find certs -name "*.cert_id" | head -1)
          if [ -n "$CERT_ID" ]; then
            echo "Certificate ID: $(cat $CERT_ID)"
          fi

          # The certificate is in the macOS keychain - export as .p12
          echo "=== Exporting P12 ==="

          # Find the signing identity
          security find-identity -v -p codesigning

          # Get the identity hash
          IDENTITY=$(security find-identity -v -p codesigning | grep "Apple Distribution" | head -1 | awk '{print $2}')

          if [ -n "$IDENTITY" ]; then
            echo "Found identity: $IDENTITY"

            # Export as p12
            security export -k ~/Library/Keychains/login.keychain-db -t identities -f pkcs12 -P "$CERT_PASSWORD" -o certificate.p12

            # Base64 encode the p12
            echo ""
            echo "=========================================="
            echo "IOS_CERTIFICATE_BASE64 (copy this value):"
            echo "=========================================="
            base64 -i certificate.p12
            echo ""
            echo "=========================================="
          else
            echo "No Apple Distribution identity found in keychain"
            echo "Trying alternate export method..."

            # List all available certs
            ls -la certs/
          fi

          # Base64 encode the provisioning profile
          PROFILE=$(find profiles -name "*.mobileprovision" | head -1)
          if [ -n "$PROFILE" ]; then
            echo ""
            echo "=========================================="
            echo "IOS_PROVISIONING_PROFILE_BASE64 (copy this value):"
            echo "=========================================="
            base64 -i "$PROFILE"
            echo ""
            echo "=========================================="

            # Extract Team ID from profile
            echo ""
            echo "=========================================="
            echo "IOS_TEAM_ID (copy this value):"
            echo "=========================================="
            security cms -D -i "$PROFILE" | grep -A1 "TeamIdentifier" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/'
            echo "=========================================="
          fi

          echo ""
          echo "IOS_CERTIFICATE_PASSWORD: Use the password you entered when triggering this workflow"
          echo ""

      - name: Upload Artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ios-signing-files
          path: |
            profiles/*.mobileprovision
          retention-days: 1
          if-no-files-found: warn
