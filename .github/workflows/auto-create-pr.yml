name: Auto Create PR

on:
  push:
    branches-ignore:
      - master
      - gh-readonly-queue/**
      - dependabot/**
      - renovate/**

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --head "${{ github.ref_name }}" --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT

      - name: Extract commit message
        if: steps.check-pr.outputs.exists == '0'
        id: commit-msg
        run: |
          # Get the first line as title
          TITLE=$(git log -1 --pretty=%s)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Get the commit body
          BODY=$(git log -1 --pretty=%b | tail -n +1)

          # Handle multiline body for GitHub Actions
          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == '0'
        env:
          # Using BOT_PAT instead of GITHUB_TOKEN to trigger CI workflows on the created PR.
          # PRs created with GITHUB_TOKEN don't trigger pull_request events (by design).
          GH_TOKEN: ${{ secrets.BOT_PAT }}
          PR_TITLE: ${{ steps.commit-msg.outputs.title }}
          PR_BODY: ${{ steps.commit-msg.outputs.body }}
        run: |
          # Use --body-file with stdin to avoid shell quoting issues with special characters
          echo "$PR_BODY" | gh pr create \
            --title "$PR_TITLE" \
            --body-file - \
            --base master \
            --head "${{ github.ref_name }}"
