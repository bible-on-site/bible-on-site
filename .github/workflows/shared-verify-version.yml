name: Shared Version Verification
on:
  workflow_call:
    inputs:
      module_name:
        description: "Module name (app, website, api)"
        required: true
        type: string

permissions:
  contents: read

env:
  DEVOPS_DIRECTORY: devops

jobs:
  verify:
    name: Verify Version
    runs-on: ubuntu-latest
    steps:
      - name: Debug context
        env:
          EVENT_NAME: ${{ github.event_name }}
          HEAD_REF: ${{ github.head_ref }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
        run: |
          echo "event_name: $EVENT_NAME"
          echo "head_ref: $HEAD_REF"
          echo "ref: $REF"
          echo "sha: $SHA"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags origin

      - name: Debug git state
        run: |
          echo "Current commit:"
          git log -1 --oneline
          echo ""
          echo "Latest website tags:"
          git tag -l "website-v*" --sort=-v:refname | head -5
          echo ""
          echo "Website package.json version:"
          cat web/bible-on-site/package.json | grep '"version"'

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: devops/package.json
          cache-dependency-path: devops/package-lock.json
          cache: npm

      - name: Install dependencies
        working-directory: ${{ env.DEVOPS_DIRECTORY }}
        run: npm ci --no-audit

      - name: Verify version
        working-directory: ${{ env.DEVOPS_DIRECTORY }}
        run: npm run verify-version -- --module ${{ inputs.module_name }}
