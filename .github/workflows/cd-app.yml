name: Continuous Deployment - App

on:
  repository_dispatch:
    types: [deploy-app]
  workflow_dispatch:
    inputs:
      ios_artifact_name:
        description: "iOS artifact name (e.g., app-ios-v4.0.35)"
        required: false
        type: string
      ci_run_id:
        description: "CI run ID that created the artifact"
        required: false
        type: string

jobs:
  deploy_google_play:
    name: Deploy to Google Play (Internal Track)
    if: ${{ github.event.client_payload.android_artifact_name != '' }}
    permissions:
      contents: read
    runs-on: ubuntu-latest

    env:
      MODULE_VERSION: ${{ github.event.client_payload.module_version }}
      ANDROID_ARTIFACT_NAME: ${{ github.event.client_payload.android_artifact_name }}
      CI_RUN_ID: ${{ github.event.client_payload.ci_run_id }}
      APP_DIRECTORY: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref }}

      - name: Restore Android AAB
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.ANDROID_ARTIFACT_NAME }}
          path: ${{ env.APP_DIRECTORY }}/.artifacts
          run-id: ${{ env.CI_RUN_ID }}
          github-token: ${{ secrets.BOT_PAT }}

      - name: Find AAB file
        id: find_aab
        run: |
          AAB_FILE=$(find ${{ env.APP_DIRECTORY }}/.artifacts -name "*.aab" | head -1)
          if [ -z "$AAB_FILE" ]; then
            echo "Error: No AAB file found"
            exit 1
          fi
          # NUKE requires absolute paths
          AAB_FILE=$(realpath "$AAB_FILE")
          echo "AAB_FILE=$AAB_FILE" >> $GITHUB_OUTPUT
          echo "Found AAB: $AAB_FILE"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Write service account key
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > ${{ runner.temp }}/service-account.json

      - name: Restore dotnet tools
        working-directory: ${{ env.APP_DIRECTORY }}
        run: dotnet tool restore

      - name: Upload to Google Play
        working-directory: ${{ env.APP_DIRECTORY }}
        run: |
          dotnet run --project devops -- DeployGooglePlay \
            --aab-path "${{ steps.find_aab.outputs.AAB_FILE }}" \
            --google-play-key-file "${{ runner.temp }}/service-account.json"

      - name: Cleanup
        if: always()
        run: rm -f ${{ runner.temp }}/service-account.json

      - name: Deployment Summary
        run: |
          echo "## Android Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.MODULE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Track:** Internal" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deployed ✅" >> $GITHUB_STEP_SUMMARY

  deploy_microsoft_store:
    name: Deploy to Microsoft Store
    if: ${{ github.event.client_payload.windows_artifact_name != '' }}
    permissions:
      contents: read
    runs-on: windows-latest

    env:
      MODULE_VERSION: ${{ github.event.client_payload.module_version }}
      WINDOWS_ARTIFACT_NAME: ${{ github.event.client_payload.windows_artifact_name }}
      CI_RUN_ID: ${{ github.event.client_payload.ci_run_id }}
      APP_DIRECTORY: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref }}

      - name: Restore Windows MSIX
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.WINDOWS_ARTIFACT_NAME }}
          path: ${{ env.APP_DIRECTORY }}/.artifacts
          run-id: ${{ env.CI_RUN_ID }}
          github-token: ${{ secrets.BOT_PAT }}

      - name: Find MSIX file
        id: find_msix
        shell: pwsh
        run: |
          # Find the app MSIX (not dependencies like WindowsAppRuntime)
          $msixFiles = Get-ChildItem -Path "${{ env.APP_DIRECTORY }}/.artifacts" -Recurse -Include "BibleOnSite*.msix","BibleOnSite*.msixupload" | Select-Object -First 1
          if (-not $msixFiles) {
            Write-Error "No app MSIX file found"
            Get-ChildItem -Path "${{ env.APP_DIRECTORY }}/.artifacts" -Recurse -Include "*.msix*"
            exit 1
          }
          $msixPath = $msixFiles.FullName
          "MSIX_FILE=$msixPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Found MSIX: $msixPath"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Setup Microsoft Store Developer CLI
        uses: microsoft/setup-msstore-cli@v1

      - name: Configure Microsoft Store Developer CLI
        shell: pwsh
        run: |
          msstore reconfigure `
            --tenantId ${{ secrets.MS_STORE_TENANT_ID }} `
            --sellerId ${{ secrets.MS_STORE_SELLER_ID }} `
            --clientId ${{ secrets.MS_STORE_CLIENT_ID }} `
            --clientSecret ${{ secrets.MS_STORE_CLIENT_SECRET }}

      - name: Restore dotnet tools
        working-directory: ${{ env.APP_DIRECTORY }}
        run: dotnet tool restore

      - name: Upload to Microsoft Store
        working-directory: ${{ env.APP_DIRECTORY }}
        shell: pwsh
        env:
          PARTNER_CENTER_TENANT_ID: ${{ secrets.MS_STORE_TENANT_ID }}
          PARTNER_CENTER_CLIENT_ID: ${{ secrets.MS_STORE_CLIENT_ID }}
          PARTNER_CENTER_CLIENT_SECRET: ${{ secrets.MS_STORE_CLIENT_SECRET }}
        run: |
          # Create a new flight for each deployment (avoids issues with Partner Center-created submissions)
          dotnet run --project devops -- DeployMsStore `
            --msix-path "${{ steps.find_msix.outputs.MSIX_FILE }}" `
            --ms-store-flight-group-id "${{ secrets.MS_STORE_FLIGHT_GROUP_ID }}" `
            --max-flights-to-keep 99999

      - name: Deployment Summary
        shell: pwsh
        run: |
          "## Windows Deployment Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Version:** ${{ env.MODULE_VERSION }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Target:** Microsoft Store (Internal Flight)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Status:** Submitted ✅" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

  deploy_app_store:
    name: Deploy to App Store (TestFlight)
    if: ${{ github.event.client_payload.ios_artifact_name != '' || inputs.ios_artifact_name != '' }}
    permissions:
      contents: read
    runs-on: macos-15

    env:
      MODULE_VERSION: ${{ github.event.client_payload.module_version || '0.0.0' }}
      IOS_ARTIFACT_NAME: ${{ github.event.client_payload.ios_artifact_name || inputs.ios_artifact_name }}
      CI_RUN_ID: ${{ github.event.client_payload.ci_run_id || inputs.ci_run_id }}
      APP_DIRECTORY: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore iOS IPA
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.IOS_ARTIFACT_NAME }}
          path: ${{ env.APP_DIRECTORY }}/.artifacts
          run-id: ${{ env.CI_RUN_ID }}
          github-token: ${{ secrets.BOT_PAT }}

      - name: Find IPA file
        id: find_ipa
        run: |
          IPA_FILE=$(find ${{ env.APP_DIRECTORY }}/.artifacts -name "*.ipa" | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "Error: No IPA file found"
            exit 1
          fi
          IPA_FILE=$(realpath "$IPA_FILE")
          echo "IPA_FILE=$IPA_FILE" >> $GITHUB_OUTPUT
          echo "Found IPA: $IPA_FILE"

      - name: Setup App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          mkdir -p $HOME/private_keys
          # Decode the .p8 key file
          echo -n "$API_KEY_BASE64" | base64 --decode > $HOME/private_keys/AuthKey_${API_KEY_ID}.p8
          # Create JSON file that Fastlane expects
          cat > $HOME/private_keys/api_key.json << EOF
          {
            "key_id": "${API_KEY_ID}",
            "issuer_id": "${API_ISSUER_ID}",
            "key": "$(cat $HOME/private_keys/AuthKey_${API_KEY_ID}.p8 | sed 's/$/\\n/' | tr -d '\n')",
            "in_house": false
          }
          EOF
          echo "API_KEY_PATH=$HOME/private_keys/api_key.json" >> $GITHUB_ENV

      - name: Install Fastlane
        run: gem install fastlane -NV

      - name: Upload to TestFlight and Distribute to Beta Group
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          TESTFLIGHT_BETA_GROUP: ${{ secrets.TESTFLIGHT_BETA_GROUP_NAME }}
        run: |
          # Create Fastlane config
          mkdir -p fastlane
          cat > fastlane/Appfile << EOF
          app_identifier("com.tanah.daily929")
          EOF

          # Try to upload, and if build already exists, just distribute the existing one
          UPLOAD_OUTPUT=$(fastlane pilot upload \
            --ipa "${{ steps.find_ipa.outputs.IPA_FILE }}" \
            --api_key_path "${{ env.API_KEY_PATH }}" \
            --skip_waiting_for_build_processing false \
            --distribute_external true \
            --groups "${TESTFLIGHT_BETA_GROUP}" \
            --beta_app_description "929 - תנ\"ך על הפרק: Daily Bible study app following the 929 project curriculum." \
            --beta_app_feedback_email "support@929.org.il" \
            --changelog "Automated build v${{ env.MODULE_VERSION }}" 2>&1) || {
            if echo "$UPLOAD_OUTPUT" | grep -q "bundle version must be higher"; then
              echo "Build already exists in TestFlight. Distributing existing build..."
              # Extract build number from IPA (it's in the version string)
              fastlane pilot distribute \
                --api_key_path "${{ env.API_KEY_PATH }}" \
                --app_identifier "com.tanah.daily929" \
                --distribute_external true \
                --groups "${TESTFLIGHT_BETA_GROUP}" \
                --beta_app_description "929 - תנ\"ך על הפרק: Daily Bible study app following the 929 project curriculum." \
                --beta_app_feedback_email "support@929.org.il"
            else
              echo "$UPLOAD_OUTPUT"
              exit 1
            fi
          }
          echo "$UPLOAD_OUTPUT"

      - name: Cleanup
        if: always()
        run: rm -rf $HOME/private_keys

      - name: Deployment Summary
        run: |
          echo "## iOS Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.MODULE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Uploaded ✅" >> $GITHUB_STEP_SUMMARY
