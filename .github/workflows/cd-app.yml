name: Continuous Deployment - App

on:
  repository_dispatch:
    types: [deploy-app]

jobs:
  deploy_google_play:
    name: Deploy to Google Play (Internal Track)
    if: ${{ github.event.client_payload.android_artifact_name != '' }}
    permissions:
      contents: read
    runs-on: ubuntu-latest

    env:
      MODULE_VERSION: ${{ github.event.client_payload.module_version }}
      ANDROID_ARTIFACT_NAME: ${{ github.event.client_payload.android_artifact_name }}
      CI_RUN_ID: ${{ github.event.client_payload.ci_run_id }}
      APP_DIRECTORY: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref }}

      - name: Restore Android AAB
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.ANDROID_ARTIFACT_NAME }}
          path: ${{ env.APP_DIRECTORY }}/.artifacts
          run-id: ${{ env.CI_RUN_ID }}
          github-token: ${{ secrets.BOT_PAT }}

      - name: Find AAB file
        id: find_aab
        run: |
          AAB_FILE=$(find ${{ env.APP_DIRECTORY }}/.artifacts -name "*.aab" | head -1)
          if [ -z "$AAB_FILE" ]; then
            echo "Error: No AAB file found"
            exit 1
          fi
          # NUKE requires absolute paths
          AAB_FILE=$(realpath "$AAB_FILE")
          echo "AAB_FILE=$AAB_FILE" >> $GITHUB_OUTPUT
          echo "Found AAB: $AAB_FILE"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Write service account key
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > ${{ runner.temp }}/service-account.json

      - name: Restore dotnet tools
        working-directory: ${{ env.APP_DIRECTORY }}
        run: dotnet tool restore

      - name: Upload to Google Play
        working-directory: ${{ env.APP_DIRECTORY }}
        run: |
          dotnet run --project devops -- DeployGooglePlay \
            --aab-path "${{ steps.find_aab.outputs.AAB_FILE }}" \
            --google-play-key-file "${{ runner.temp }}/service-account.json"

      - name: Cleanup
        if: always()
        run: rm -f ${{ runner.temp }}/service-account.json

      - name: Deployment Summary
        run: |
          echo "## Android Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.MODULE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Track:** Internal" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deployed ✅" >> $GITHUB_STEP_SUMMARY

  deploy_microsoft_store:
    name: Deploy to Microsoft Store
    if: ${{ github.event.client_payload.windows_artifact_name != '' }}
    permissions:
      contents: read
    runs-on: windows-latest

    env:
      MODULE_VERSION: ${{ github.event.client_payload.module_version }}
      WINDOWS_ARTIFACT_NAME: ${{ github.event.client_payload.windows_artifact_name }}
      CI_RUN_ID: ${{ github.event.client_payload.ci_run_id }}
      APP_DIRECTORY: app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref }}

      - name: Restore Windows MSIX
        uses: actions/download-artifact@v7
        with:
          name: ${{ env.WINDOWS_ARTIFACT_NAME }}
          path: ${{ env.APP_DIRECTORY }}/.artifacts
          run-id: ${{ env.CI_RUN_ID }}
          github-token: ${{ secrets.BOT_PAT }}

      - name: Find MSIX file
        id: find_msix
        shell: pwsh
        run: |
          # Find the app MSIX (not dependencies like WindowsAppRuntime)
          $msixFiles = Get-ChildItem -Path "${{ env.APP_DIRECTORY }}/.artifacts" -Recurse -Include "BibleOnSite*.msix","BibleOnSite*.msixupload" | Select-Object -First 1
          if (-not $msixFiles) {
            Write-Error "No app MSIX file found"
            Get-ChildItem -Path "${{ env.APP_DIRECTORY }}/.artifacts" -Recurse -Include "*.msix*"
            exit 1
          }
          $msixPath = $msixFiles.FullName
          "MSIX_FILE=$msixPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Found MSIX: $msixPath"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Setup Microsoft Store Developer CLI
        uses: microsoft/setup-msstore-cli@v1

      - name: Configure Microsoft Store Developer CLI
        shell: pwsh
        run: |
          msstore reconfigure `
            --tenantId ${{ secrets.MS_STORE_TENANT_ID }} `
            --sellerId ${{ secrets.MS_STORE_SELLER_ID }} `
            --clientId ${{ secrets.MS_STORE_CLIENT_ID }} `
            --clientSecret ${{ secrets.MS_STORE_CLIENT_SECRET }}

      - name: Restore dotnet tools
        working-directory: ${{ env.APP_DIRECTORY }}
        run: dotnet tool restore

      - name: Upload to Microsoft Store
        working-directory: ${{ env.APP_DIRECTORY }}
        shell: pwsh
        env:
          PARTNER_CENTER_TENANT_ID: ${{ secrets.MS_STORE_TENANT_ID }}
          PARTNER_CENTER_CLIENT_ID: ${{ secrets.MS_STORE_CLIENT_ID }}
          PARTNER_CENTER_CLIENT_SECRET: ${{ secrets.MS_STORE_CLIENT_SECRET }}
        run: |
          # Create a new flight for each deployment (avoids issues with Partner Center-created submissions)
          dotnet run --project devops -- DeployMsStore `
            --msix-path "${{ steps.find_msix.outputs.MSIX_FILE }}" `
            --ms-store-flight-group-id "${{ secrets.MS_STORE_FLIGHT_GROUP_ID }}" `
            --max-flights-to-keep 99999

      - name: Deployment Summary
        shell: pwsh
        run: |
          "## Windows Deployment Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Version:** ${{ env.MODULE_VERSION }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Target:** Microsoft Store (Internal Flight)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Status:** Submitted ✅" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
