<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             x:Class="BibleOnSite.Pages.AuthorsPage"
             x:DataType="viewmodels:AuthorsViewModel"
             Title="רבנים"
             FlowDirection="RightToLeft">

       <Grid RowDefinitions="Auto,*">
              <!-- Search Bar -->
              <SearchBar Grid.Row="0"
                         Placeholder="חיפוש רבנים..."
                         Text="{Binding SearchPhrase}"
                         TextChanged="OnSearchTextChanged"
                         HorizontalTextAlignment="End"
                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                         Margin="8,8,8,0"/>

              <!-- Authors Grid with CollectionView for virtualization/lazy loading -->
              <CollectionView Grid.Row="1"
                              ItemsSource="{Binding FilteredAuthors}"
                              Margin="8,8,8,0"
                              ItemsLayout="VerticalGrid, 2"
                              SelectionMode="None">
                     <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Author">
                                   <Border Padding="0"
                                           Margin="4"
                                           StrokeShape="RoundRectangle 12"
                                           Stroke="Transparent"
                                           BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                          <Border.Shadow>
                                                 <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.15"/>
                                          </Border.Shadow>
                                          <Border.GestureRecognizers>
                                                 <TapGestureRecognizer Tapped="OnAuthorTapped"
                                                                       CommandParameter="{Binding .}"/>
                                          </Border.GestureRecognizers>
                                          <Grid RowDefinitions="Auto,Auto,Auto,*"
                                                Padding="8"
                                                InputTransparent="True">
                                                 <!-- Author Image with lazy loading -->
                                                 <Border Grid.Row="0"
                                                         WidthRequest="80"
                                                         HeightRequest="80"
                                                         StrokeShape="RoundRectangle 40"
                                                         Stroke="{StaticResource Primary}"
                                                         StrokeThickness="1"
                                                         HorizontalOptions="Center">
                                                        <Image Source="{Binding ImageUrl}"
                                                               Aspect="AspectFill"
                                                               WidthRequest="80"
                                                               HeightRequest="80"/>
                                                 </Border>

                                                 <!-- Author Name -->
                                                 <Label Grid.Row="1"
                                                        Text="{Binding Name}"
                                                        FontSize="14"
                                                        FontAttributes="Bold"
                                                        HorizontalTextAlignment="Center"
                                                        MaxLines="2"
                                                        LineBreakMode="TailTruncation"
                                                        Margin="0,8,0,0"/>

                                                 <!-- Articles Count -->
                                                 <Label Grid.Row="2"
                                                        Text="{Binding ArticlesCount, StringFormat='{0} מאמרים'}"
                                                        FontSize="11"
                                                        HorizontalTextAlignment="Center"
                                                        TextColor="{StaticResource Primary}"/>

                                                 <!-- Details -->
                                                 <Label Grid.Row="3"
                                                        Text="{Binding Details}"
                                                        FontSize="11"
                                                        HorizontalTextAlignment="Center"
                                                        LineBreakMode="TailTruncation"
                                                        MaxLines="2"
                                                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                                        Margin="0,4,0,8"/>
                                          </Grid>
                                   </Border>
                            </DataTemplate>
                     </CollectionView.ItemTemplate>
              </CollectionView>

              <!-- Empty/Loading State Overlay -->
              <VerticalStackLayout Grid.Row="1"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   Padding="20"
                                   IsVisible="{Binding FilteredAuthors.Count, Converter={StaticResource ZeroToTrueConverter}}">
                     <ActivityIndicator IsRunning="{Binding IsLoading}"
                                        IsVisible="{Binding IsLoading}"/>
                     <Label Text="טוען רבנים..."
                            FontSize="16"
                            HorizontalTextAlignment="Center"
                            IsVisible="{Binding IsLoading}"/>
                     <Label Text="לא נמצאו רבנים"
                            FontSize="16"
                            HorizontalTextAlignment="Center"
                            IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"/>
              </VerticalStackLayout>
       </Grid>
</ContentPage>
