<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             xmlns:controls="clr-namespace:BibleOnSite.Controls"
             xmlns:behaviors="clr-namespace:BibleOnSite.Behaviors"
             xmlns:converters="clr-namespace:BibleOnSite.Converters"
             x:Class="BibleOnSite.Pages.PerekPage"
             x:Name="PerekPageRoot"
             x:DataType="viewmodels:PerekViewModel"
             Title="{Binding Source}"
             FlowDirection="RightToLeft">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="SelectedPasukBackground">#E3F2FD</Color>
            <Color x:Key="SelectedPasukBackgroundDark">#1E3A5F</Color>
            <converters:IntEqualityConverter x:Key="IntEqualityConverter"/>
            <!-- DataTrigger helper for selection background -->
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="MainGrid">

        <!-- Exit Full Screen Button (floating, hidden by default) -->
        <!-- Position: End = right side in RTL (where fullscreen button was) -->
        <!-- Icon: full_screen_minimize_24_regular = \ue688 -->
        <Border x:Name="ExitFullScreenButton"
                WidthRequest="48"
                HeightRequest="48"
                StrokeShape="RoundRectangle 24"
                BackgroundColor="{StaticResource Primary}"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="16,16,16,100"
                IsVisible="False"
                ZIndex="100">
            <Border.Shadow>
                <Shadow Brush="Black"
                        Offset="0,3"
                        Radius="6"
                        Opacity="0.3"/>
            </Border.Shadow>
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnExitFullScreenClicked"/>
                <PanGestureRecognizer PanUpdated="OnExitFullScreenButtonPan"/>
            </Border.GestureRecognizers>
            <Label Text="&#xe688;"
                   FontFamily="FluentIcons"
                   FontSize="24"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HorizontalTextAlignment="Center"
                   VerticalTextAlignment="Center"/>
        </Border>

        <!-- Main Content Area - fills entire viewport -->
        <Grid x:Name="ContentArea"
              ZIndex="0"
              RowDefinitions="Auto,Auto,*">

            <!-- Selection Bar (Row 0 - hidden by default) -->
            <Grid Grid.Row="0"
                  x:Name="SelectionBar"
                  AutomationId="SelectionBar"
                  IsVisible="False"
                  BackgroundColor="{StaticResource Primary}"
                  Padding="4,5"
                  ColumnDefinitions="Auto,Auto,*,Auto,Auto">
                <Grid.HeightRequest>
                    <OnPlatform x:TypeArguments="x:Double" Default="48">
                        <On Platform="Android,iOS" Value="56"/>
                    </OnPlatform>
                </Grid.HeightRequest>
                <!-- Back button - arrow_right_24_regular = \uf182 -->
                <Button Grid.Column="0"
                        x:Name="SelectionBackButton"
                        AutomationId="SelectionBackButton"
                        Text="&#xf182;"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionBackClicked"/>
                <!-- Badge with count -->
                <Border Grid.Column="1"
                        BackgroundColor="White"
                        StrokeShape="RoundRectangle 12"
                        Stroke="Transparent"
                        Padding="8,2"
                        MinimumWidthRequest="24"
                        HeightRequest="24"
                        VerticalOptions="Center"
                        Margin="4,0">
                    <Label x:Name="SelectionCountLabel"
                           AutomationId="SelectionCountLabel"
                           Text="0"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"
                           HorizontalTextAlignment="Center"
                           VerticalTextAlignment="Center"/>
                </Border>
                <!-- Spacer (transparent) -->
                <ContentView Grid.Column="2"/>
                <!-- Share button - share_24_regular = \uf6b0 -->
                <Button Grid.Column="3"
                        AutomationId="SelectionShareButton"
                        Text="&#xf6b0;"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionShareClicked"/>
                <!-- Copy button - copy_24_regular = \uf32b -->
                <Button Grid.Column="4"
                        x:Name="SelectionCopyButton"
                        AutomationId="SelectionCopyButton"
                        Text="&#xf32b;"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionCopyClicked"/>
            </Grid>

            <!-- Perek Header (Row 1 - always visible) -->
            <Label Grid.Row="1"
                   x:Name="PerekHeader"
                   Text="{Binding Header}"
                   FontSize="22"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"
                   Padding="16,12"
                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"/>

            <!-- Perek Text - Pasukim List (Row 2) -->
            <CollectionView Grid.Row="2"
                            x:Name="PasukimCollection"
                            ItemsSource="{Binding Perek.Pasukim}"
                            SelectionMode="None"
                            Scrolled="OnPasukimScrolled"
                            Margin="8,0,8,0">
                <!-- Footer spacer so last item can scroll above bottom bar -->
                <CollectionView.Footer>
                    <ContentView x:Name="PasukimFooterSpacer" HeightRequest="90" BackgroundColor="Transparent"/>
                </CollectionView.Footer>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Pasuk">
                        <Border Padding="12,8"
                                Margin="0,4"
                                StrokeShape="RoundRectangle 8"
                                Stroke="Transparent"
                                x:Name="PasukBorder"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                    <Setter Property="BackgroundColor" Value="{StaticResource SelectedPasukBackground}"/>
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnPasukTapped"
                                                      CommandParameter="{Binding PasukNum}"/>
                                <TapGestureRecognizer Tapped="OnPasukRightClicked"
                                                      CommandParameter="{Binding PasukNum}"
                                                      Buttons="Secondary"/>
                                <PointerGestureRecognizer PointerPressed="OnPasukPointerPressed"
                                                          PointerReleased="OnPasukPointerReleased"/>
                            </Border.GestureRecognizers>
                            <Border.Behaviors>
                                <behaviors:LongPressBehavior LongPressDuration="600"
                                                             LongPressed="OnPasukLongPressed"/>
                            </Border.Behaviors>
                            <Grid ColumnDefinitions="40,*">
                                <Label Grid.Column="0"
                                       Text="{Binding PasukNumHeb}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       VerticalTextAlignment="Start"
                                       Margin="0,1.5,0,0"
                                       TextColor="{StaticResource Primary}"/>
                                <Label Grid.Column="1"
                                       AutomationId="PasukText"
                                       FormattedText="{Binding FormattedText}"
                                       FontSize="18"
                                       LineBreakMode="WordWrap"
                                       LineHeight="1.4"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="20">
                        <Label Text="×ž×ª×—×‘×¨ ×œ×¤×¨×§..."
                               AutomationId="PerekLoadingLabel"
                               FontSize="18"
                               HorizontalTextAlignment="Center"/>
                        <ActivityIndicator IsRunning="True"
                                           Margin="0,10,0,0"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!-- Swipe navigation disabled - built-in SwipeGestureRecognizer causes crashes on Android.
                 TODO: Implement using CarouselView with virtualized items (prev/current/next perek).
                 CarouselView is the native MAUI solution for book-like swipe navigation.
                 See: https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/carouselview
                 For now, users can use prev/next buttons in circular menu. -->

            <!-- Articles View (hidden by default, shown when articles button clicked) -->
            <!-- Uses shared ArticleCard component -->
            <CollectionView Grid.Row="2"
                            x:Name="ArticlesCollection"
                            IsVisible="False"
                            SelectionMode="Single"
                            SelectionChanged="OnArticleSelected"
                            Margin="8,8,8,0">
                <!-- Footer spacer so last item can scroll above bottom bar -->
                <CollectionView.Footer>
                    <ContentView x:Name="ArticlesFooterSpacer" HeightRequest="90" BackgroundColor="Transparent"/>
                </CollectionView.Footer>
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="2"
                                     HorizontalItemSpacing="8"
                                     VerticalItemSpacing="8"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Article">
                        <Border Padding="0"
                                StrokeShape="RoundRectangle 12"
                                Stroke="Transparent"
                                BackgroundColor="Transparent">
                                <Border.Triggers>
                                <DataTrigger TargetType="Border" Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IntEqualityConverter}">
                                            <Binding Path="Id"/>
                                            <Binding Source="{x:Reference PerekPageRoot}" Path="SelectedArticleId"/>
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light={StaticResource SelectedPasukBackground}, Dark={StaticResource SelectedPasukBackgroundDark}}"/>
                                </DataTrigger>
                            </Border.Triggers>
                            <controls:ArticleCard Article="{Binding .}"/>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="20">
                        <Label Text="××™×Ÿ ×ž××ž×¨×™× ×œ×¤×¨×§ ×–×”"
                               FontSize="18"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- Perushim Panel (slides up from bottom, above content but behind bottom bar) -->
        <Border x:Name="PerushimPanel"
                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                StrokeShape="RoundRectangle 16,16,0,0"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                VerticalOptions="End"
                ZIndex="50"
                IsVisible="False">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,-3" Radius="8" Opacity="0.2"/>
            </Border.Shadow>
            <Grid RowDefinitions="Auto,*" Padding="16,12,16,0">
                <!-- Header with drag handle -->
                <VerticalStackLayout Grid.Row="0" Spacing="4">
                    <!-- Drag handle indicator -->
                    <BoxView WidthRequest="40"
                             HeightRequest="4"
                             CornerRadius="2"
                             BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray500}}"
                             HorizontalOptions="Center"
                             Margin="0,0,0,4"/>
                    <!-- Title -->
                    <Label Text="×¤×™×¨×•×©×™×"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"/>
                    <!-- Divider -->
                    <BoxView HeightRequest="1"
                             BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                             Margin="0,4,0,0"/>
                </VerticalStackLayout>
                <!-- Scrollable content area for perushim list -->
                <ScrollView Grid.Row="1" Margin="0,8,0,90">
                    <!-- Placeholder - will be replaced with actual perushim list -->
                    <VerticalStackLayout VerticalOptions="Start"
                                         HorizontalOptions="Center"
                                         Spacing="8"
                                         Padding="0,16,0,0">
                        <Label Text="ðŸ“š"
                               FontSize="32"
                               HorizontalTextAlignment="Center"/>
                        <Label Text="×‘×§×¨×•×‘ ×™×—×–×¨×• ×”×¤×™×¨×•×©×™×"
                               FontSize="14"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                    </VerticalStackLayout>
                </ScrollView>
            </Grid>
        </Border>

        <!-- Bottom Navigation Bar with Circular Menu - OVERLAY floating at bottom -->
        <Grid x:Name="BottomBar"
              HeightRequest="90"
              VerticalOptions="End"
              ZIndex="100"
              BackgroundColor="Transparent">
            <!-- Background shape with notch - content shows through the notch -->
            <AbsoluteLayout BackgroundColor="Transparent">
                <GraphicsView x:Name="BottomBarBackground"
                              AbsoluteLayout.LayoutBounds="0,0,1,1"
                              AbsoluteLayout.LayoutFlags="All"
                              BackgroundColor="Transparent"
                              Drawable="{StaticResource BottomBarDrawable}"/>

                <!-- Bottom bar buttons - evenly distributed (RTL: 20%=right, 80%=left) -->
                <!-- Original order from right to left: Chevron, Text, Articles, FullScreen -->

                <!-- Perushim Chevron Button at 8% -->
                <!-- Icon: chevron_up_24_regular = \uf2b7, chevron_down_24_regular = \uf2a4 -->
                <Button x:Name="PerushimChevronButton"
                        Text="&#xf2b7;"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnPerushimChevronClicked"
                        AbsoluteLayout.LayoutBounds="0.08,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

                <!-- Text Button at 28% - vertical × ×‘ ×’ -->
                <Button x:Name="TextButton"
                        Text="×&#x0a;×‘&#x0a;×’"
                        FontSize="10"
                        FontAttributes="Bold"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        LineBreakMode="WordWrap"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnTextButtonClicked"
                        AbsoluteLayout.LayoutBounds="0.28,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

                <!-- Articles Button with Badge at 72% -->
                <!-- Icon: document_24_regular = \uf379 -->
                <Grid WidthRequest="50"
                      HeightRequest="44"
                      AbsoluteLayout.LayoutBounds="0.72,0.55"
                      AbsoluteLayout.LayoutFlags="PositionProportional">
                    <Button x:Name="ArticlesButton"
                            Text="&#xf379;"
                            FontFamily="FluentIcons"
                            FontSize="20"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnArticlesButtonClicked"
                            HorizontalOptions="Center"/>
                    <!-- Badge (red, on top of button) -->
                    <Border x:Name="ArticlesBadge"
                            BackgroundColor="#E53935"
                            StrokeShape="RoundRectangle 10"
                            Stroke="Transparent"
                            Padding="4,1"
                            MinimumWidthRequest="16"
                            HorizontalOptions="Center"
                            VerticalOptions="Start"
                            Margin="8,-2,0,0"
                            IsVisible="False">
                        <Label Text="{Binding ArticlesCount}"
                               FontSize="11"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalTextAlignment="Center"
                               VerticalTextAlignment="Center"/>
                    </Border>
                </Grid>

                <!-- Full Screen Button at 92% -->
                <!-- Icon: full_screen_maximize_24_regular = \ue685 -->
                <Button x:Name="FullScreenButton"
                        Text="&#xe685;"
                        FontFamily="FluentIcons"
                        FontSize="22"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnFullScreenClicked"
                        AbsoluteLayout.LayoutBounds="0.92,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

            </AbsoluteLayout>
        </Grid>

        <!-- Satellite buttons overlay - uses AbsoluteLayout for precise positioning -->
        <AbsoluteLayout x:Name="FloatingMenuContainer"
                        ZIndex="150"
                        InputTransparent="True"
                        CascadeInputTransparent="False"
                        BackgroundColor="Transparent">

            <!-- 4 satellite buttons - fan out from center -->

            <!-- Previous perek (bottom-left satellite, overlaps with bar) -->
            <!-- Icon: document_arrow_right_24_regular = \ue4e7 -->
            <Button x:Name="PrevPerekButton"
                    Text="&#xe4e7;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadPreviousCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.26,0.91,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Today's perek (top-left satellite) -->
            <!-- Icon: calendar_today_24_regular = \uf23d -->
            <Button x:Name="TodayButton"
                    Text="&#xf23d;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadTodayCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.42,0.87,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Perek Picker (top-right satellite) -->
            <!-- Icon: library_24_regular = \uf4d3 -->
            <Button x:Name="PerekPickerButton"
                    Text="&#xf4d3;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Clicked="OnPerekPickerClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.58,0.87,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Next perek (bottom-right satellite, overlaps with bar) -->
            <!-- Icon: document_arrow_right mirrored -->
            <Button x:Name="NextPerekButton"
                    Text="&#xe4e7;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    ScaleX="-1"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadNextCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.74,0.91,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Center Circular FAB - placed last to be on top, sits in notch -->
            <Button x:Name="CircularMenuButton"
                    Text="â˜°"
                    FontSize="22"
                    WidthRequest="56"
                    HeightRequest="56"
                    CornerRadius="28"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    Clicked="OnCircularMenuClicked"
                    AbsoluteLayout.LayoutBounds="0.5,0.95,56,56"
                    AbsoluteLayout.LayoutFlags="PositionProportional">
                <Button.Shadow>
                    <Shadow Brush="Black"
                            Offset="0,3"
                            Radius="6"
                            Opacity="0.3"/>
                </Button.Shadow>
            </Button>
        </AbsoluteLayout>

        <!-- Perek Picker Popup Overlay -->
        <controls:PerekPickerPopup x:Name="PerekPickerPopup"
                                   ZIndex="200"
                                   PerekSelected="OnPerekPickerSelected"/>
    </Grid>

</ContentPage>
