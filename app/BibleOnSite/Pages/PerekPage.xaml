<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             xmlns:controls="clr-namespace:BibleOnSite.Controls"
             x:Class="BibleOnSite.Pages.PerekPage"
             x:DataType="viewmodels:PerekViewModel"
             Title="{Binding Source}"
             FlowDirection="RightToLeft">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="SelectedPasukBackground">#E3F2FD</Color>
            <Color x:Key="SelectedPasukBackgroundDark">#1E3A5F</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="MainGrid"
            RowDefinitions="*,90">

        <!-- DEBUG WATERMARK - Remove after testing -->
        <Label x:Name="DebugWatermark"
               Grid.Row="0"
               Text="DEBUG v13"
               FontSize="10"
               TextColor="Red"
               BackgroundColor="#40FFFF00"
               HorizontalOptions="Start"
               VerticalOptions="Start"
               Padding="4,2"
               ZIndex="999"/>

        <!-- Exit Full Screen Button (floating, hidden by default) -->
        <!-- Position: End = right side in RTL (where fullscreen button was) -->
        <!-- Icon: full_screen_minimize_24_regular = \ue688 -->
        <Button x:Name="ExitFullScreenButton"
                Grid.Row="0"
                Text="&#xe688;"
                FontFamily="FluentIcons"
                FontSize="24"
                WidthRequest="48"
                HeightRequest="48"
                CornerRadius="24"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="16"
                Clicked="OnExitFullScreenClicked"
                IsVisible="False"
                ZIndex="100">
            <Button.Shadow>
                <Shadow Brush="Black"
                        Offset="0,3"
                        Radius="6"
                        Opacity="0.3"/>
            </Button.Shadow>
        </Button>

        <!-- Main Content Area -->
        <Grid Grid.Row="0"
              RowDefinitions="Auto,*">
            <!-- Perek Header -->
            <Label Grid.Row="0"
                   x:Name="PerekHeader"
                   Text="{Binding Header}"
                   FontSize="22"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"
                   Padding="16,12"
                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"/>

            <!-- Perek Text - Pasukim List -->
            <CollectionView Grid.Row="1"
                            x:Name="PasukimCollection"
                            ItemsSource="{Binding Perek.Pasukim}"
                            SelectionMode="None"
                            Margin="8,0,8,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Pasuk">
                        <Border Padding="12,8"
                                Margin="0,4"
                                StrokeShape="RoundRectangle 8"
                                Stroke="Transparent"
                                x:Name="PasukBorder"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnPasukTapped"
                                                      CommandParameter="{Binding PasukNum}"/>
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="40,*">
                                <Grid.GestureRecognizers>
                                    <PointerGestureRecognizer PointerPressed="OnPasukPointerPressed"
                                                              PointerReleased="OnPasukPointerReleased"/>
                                </Grid.GestureRecognizers>
                                <Label Grid.Column="0"
                                       Text="{Binding PasukNumHeb}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       VerticalTextAlignment="Start"
                                       TextColor="{StaticResource Primary}"/>
                                <Label Grid.Column="1"
                                       AutomationId="PasukText"
                                       Text="{Binding Text}"
                                       FontSize="18"
                                       LineBreakMode="WordWrap"
                                       LineHeight="1.4"
                                       HorizontalTextAlignment="Start"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="20">
                        <Label Text="×˜×•×¢×Ÿ..."
                               AutomationId="PerekLoadingLabel"
                               FontSize="18"
                               HorizontalTextAlignment="Center"/>
                        <ActivityIndicator IsRunning="True"
                                           Margin="0,10,0,0"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- Bottom Navigation Bar with Circular Menu -->
        <Grid Grid.Row="1"
              x:Name="BottomBar"
              HeightRequest="90"
              BackgroundColor="Transparent">
            <!-- Background shape with notch -->
            <AbsoluteLayout>
                <!-- White/dark background with curved notch -->
                <GraphicsView x:Name="BottomBarBackground"
                              AbsoluteLayout.LayoutBounds="0,0,1,1"
                              AbsoluteLayout.LayoutFlags="All"
                              Drawable="{StaticResource BottomBarDrawable}"/>

                <!-- Left side buttons (Chevron, Text × ×‘) - appears on RIGHT in RTL -->
                <HorizontalStackLayout AbsoluteLayout.LayoutBounds="0.05,0.6"
                                       AbsoluteLayout.LayoutFlags="PositionProportional"
                                       Spacing="4">
                    <!-- Perushim Chevron Button (right-most visually in RTL) -->
                    <!-- Icon: chevron_up_24_regular = \uf2b7, chevron_down_24_regular = \uf2a4 -->
                    <Button x:Name="PerushimChevronButton"
                            Text="&#xf2b7;"
                            FontFamily="FluentIcons"
                            FontSize="20"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnPerushimChevronClicked"/>
                    <!-- Text Button (middle-right) - vertical × ×‘ ×’ -->
                    <Button x:Name="TextButton"
                            Text="×&#x0a;×‘&#x0a;×’"
                            FontSize="10"
                            FontAttributes="Bold"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            LineBreakMode="WordWrap"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnTextButtonClicked"/>
                </HorizontalStackLayout>

                <!-- Right side buttons (Articles, Full Screen) - appears on LEFT in RTL -->
                <HorizontalStackLayout AbsoluteLayout.LayoutBounds="0.95,0.6"
                                       AbsoluteLayout.LayoutFlags="PositionProportional"
                                       Spacing="4">
                    <!-- Articles Button with Badge (middle-left visually in RTL) -->
                    <Grid WidthRequest="50"
                          HeightRequest="44">
                        <Button Text="ðŸ“„"
                                FontSize="18"
                                WidthRequest="44"
                                HeightRequest="44"
                                Padding="0"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                Command="{Binding GoToArticlesCommand}"
                                HorizontalOptions="Center"/>
                        <!-- Badge -->
                        <Border x:Name="ArticlesBadge"
                                BackgroundColor="{StaticResource Primary}"
                                StrokeShape="RoundRectangle 10"
                                Stroke="Transparent"
                                Padding="4,2"
                                HorizontalOptions="End"
                                VerticalOptions="Start"
                                Margin="0,-2,-2,0"
                                IsVisible="{Binding HasArticles}">
                            <Label Text="{Binding ArticlesCount}"
                                   FontSize="10"
                                   TextColor="White"
                                   HorizontalTextAlignment="Center"
                                   VerticalTextAlignment="Center"/>
                        </Border>
                    </Grid>
                    <!-- Full Screen Button (left-most visually in RTL) -->
                    <!-- Icon: full_screen_maximize_24_regular = \ue685 -->
                    <Button x:Name="FullScreenButton"
                            Text="&#xe685;"
                            FontFamily="FluentIcons"
                            FontSize="22"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnFullScreenClicked"/>
                </HorizontalStackLayout>

            </AbsoluteLayout>
        </Grid>

        <!-- Satellite buttons overlay - uses AbsoluteLayout for precise positioning -->
        <AbsoluteLayout x:Name="FloatingMenuContainer"
                        Grid.Row="0"
                        Grid.RowSpan="2"
                        InputTransparent="True"
                        CascadeInputTransparent="False"
                        BackgroundColor="Transparent">

            <!-- 4 satellite buttons - fan out from center -->

            <!-- Previous perek (visually on RIGHT in RTL) -->
            <!-- Icon: document_arrow_right_24_regular = \ue4e7 -->
            <Button x:Name="PrevPerekButton"
                    Text="&#xe4e7;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadPreviousCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.3,0.85,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Perek Picker (upper-left, swapped with Today) -->
            <Button x:Name="PerekPickerButton"
                    Text="ðŸ“…"
                    FontSize="18"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Clicked="OnPerekPickerClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.4,0.78,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Today's perek (upper-right, swapped with Picker) -->
            <Button x:Name="TodayButton"
                    Text="ðŸ“Š"
                    FontSize="18"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadTodayCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.6,0.78,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Next perek (visually on LEFT in RTL) -->
            <!-- Icon: document_arrow_left_24_regular = \ue4e3 -->
            <Button x:Name="NextPerekButton"
                    Text="&#xe4e3;"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadNextCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.7,0.85,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Center Circular FAB - placed last to be on top -->
            <Button x:Name="CircularMenuButton"
                    Text="â˜°"
                    FontSize="22"
                    WidthRequest="56"
                    HeightRequest="56"
                    CornerRadius="28"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    Clicked="OnCircularMenuClicked"
                    AbsoluteLayout.LayoutBounds="0.5,0.89,56,56"
                    AbsoluteLayout.LayoutFlags="PositionProportional">
                <Button.Shadow>
                    <Shadow Brush="Black"
                            Offset="0,3"
                            Radius="6"
                            Opacity="0.3"/>
                </Button.Shadow>
            </Button>
        </AbsoluteLayout>
    </Grid>

</ContentPage>
