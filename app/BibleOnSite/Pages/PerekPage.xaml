<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             xmlns:controls="clr-namespace:BibleOnSite.Controls"
             x:Class="BibleOnSite.Pages.PerekPage"
             x:DataType="viewmodels:PerekViewModel"
             Title="{Binding Source}"
             FlowDirection="RightToLeft">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="SelectedPasukBackground">#E3F2FD</Color>
            <Color x:Key="SelectedPasukBackgroundDark">#1E3A5F</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <!-- Perek Text - Pasukim List -->
        <CollectionView Grid.Row="0"
                        x:Name="PasukimCollection"
                        ItemsSource="{Binding Perek.Pasukim}"
                        SelectionMode="None"
                        Margin="8,0,8,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Pasuk">
                    <Border Padding="12,8"
                            Margin="0,4"
                            StrokeShape="RoundRectangle 8"
                            Stroke="Transparent"
                            x:Name="PasukBorder"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnPasukTapped"
                                                  CommandParameter="{Binding PasukNum}"/>
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="40,*">
                            <Grid.GestureRecognizers>
                                <PointerGestureRecognizer PointerPressed="OnPasukPointerPressed"
                                                          PointerReleased="OnPasukPointerReleased"/>
                            </Grid.GestureRecognizers>
                            <Label Grid.Column="0"
                                   Text="{Binding PasukNumHeb}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   VerticalTextAlignment="Start"
                                   TextColor="{StaticResource Primary}"/>
                            <Label Grid.Column="1"
                                   AutomationId="PasukText"
                                   Text="{Binding Text}"
                                   FontSize="18"
                                   LineBreakMode="WordWrap"
                                   LineHeight="1.4"
                                   HorizontalTextAlignment="Start"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Padding="20">
                    <Label Text="×˜×•×¢×Ÿ..."
                           AutomationId="PerekLoadingLabel"
                           FontSize="18"
                           HorizontalTextAlignment="Center"/>
                    <ActivityIndicator IsRunning="True"
                                       Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Bottom Navigation Bar with Circular Menu -->
        <Grid Grid.Row="1"
              HeightRequest="90"
              BackgroundColor="Transparent">
            <!-- Background shape with notch -->
            <AbsoluteLayout>
                <!-- White/dark background with curved notch -->
                <GraphicsView x:Name="BottomBarBackground"
                              AbsoluteLayout.LayoutBounds="0,0,1,1"
                              AbsoluteLayout.LayoutFlags="All"
                              Drawable="{StaticResource BottomBarDrawable}"/>

                <!-- Left side buttons -->
                <HorizontalStackLayout AbsoluteLayout.LayoutBounds="0.1,0.6"
                                       AbsoluteLayout.LayoutFlags="PositionProportional"
                                       Spacing="8">
                    <Button Text="×ž××ž×¨×™×"
                            FontSize="12"
                            WidthRequest="70"
                            HeightRequest="40"
                            Padding="4"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Command="{Binding GoToArticlesCommand}"/>
                    <Button Text="×˜×§×¡×˜"
                            FontSize="12"
                            WidthRequest="60"
                            HeightRequest="40"
                            Padding="4"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnTextButtonClicked"/>
                </HorizontalStackLayout>

                <!-- Right side buttons -->
                <HorizontalStackLayout AbsoluteLayout.LayoutBounds="0.9,0.6"
                                       AbsoluteLayout.LayoutFlags="PositionProportional"
                                       Spacing="8">
                    <Button x:Name="ExpandButton"
                            Text="â›¶"
                            FontSize="20"
                            WidthRequest="40"
                            HeightRequest="40"
                            Padding="0"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnExpandClicked"/>
                    <Label Text="{Binding PerekId, StringFormat='{0}/929'}"
                           FontSize="11"
                           VerticalTextAlignment="Center"
                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"/>
                </HorizontalStackLayout>

                <!-- Center Circular FAB -->
                <Button x:Name="CircularMenuButton"
                        AbsoluteLayout.LayoutBounds="0.5,0,-1,-1"
                        AbsoluteLayout.LayoutFlags="XProportional"
                        Text="â˜°"
                        FontSize="22"
                        WidthRequest="56"
                        HeightRequest="56"
                        CornerRadius="28"
                        Margin="0,-8,0,0"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        Clicked="OnCircularMenuClicked">
                    <Button.Shadow>
                        <Shadow Brush="Black" Offset="0,3" Radius="6" Opacity="0.3"/>
                    </Button.Shadow>
                </Button>

                <!-- Circular Menu Items (hidden by default) -->
                <Grid x:Name="CircularMenuOverlay"
                      AbsoluteLayout.LayoutBounds="0,0,1,1"
                      AbsoluteLayout.LayoutFlags="All"
                      IsVisible="False"
                      InputTransparent="True">

                    <!-- Previous Perek Button -->
                    <Button x:Name="PrevPerekButton"
                            Text="â†’"
                            FontSize="20"
                            WidthRequest="48"
                            HeightRequest="48"
                            CornerRadius="24"
                            BackgroundColor="{StaticResource PrimaryDark}"
                            TextColor="White"
                            Command="{Binding LoadPreviousCommand}"
                            Clicked="OnMenuItemClicked"
                            HorizontalOptions="Center"
                            VerticalOptions="End"
                            Margin="0,0,0,30"
                            Opacity="0"
                            Scale="0">
                        <Button.Shadow>
                            <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.25"/>
                        </Button.Shadow>
                    </Button>

                    <!-- Today Button -->
                    <Button x:Name="TodayButton"
                            Text="ðŸ“…"
                            FontSize="18"
                            WidthRequest="48"
                            HeightRequest="48"
                            CornerRadius="24"
                            BackgroundColor="{StaticResource PrimaryDark}"
                            TextColor="White"
                            Command="{Binding LoadTodayCommand}"
                            Clicked="OnMenuItemClicked"
                            HorizontalOptions="Center"
                            VerticalOptions="End"
                            Margin="0,0,0,30"
                            Opacity="0"
                            Scale="0">
                        <Button.Shadow>
                            <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.25"/>
                        </Button.Shadow>
                    </Button>

                    <!-- Perek Picker Button -->
                    <Button x:Name="PerekPickerButton"
                            Text="ðŸ“š"
                            FontSize="18"
                            WidthRequest="48"
                            HeightRequest="48"
                            CornerRadius="24"
                            BackgroundColor="{StaticResource PrimaryDark}"
                            TextColor="White"
                            Clicked="OnPerekPickerClicked"
                            HorizontalOptions="Center"
                            VerticalOptions="End"
                            Margin="0,0,0,30"
                            Opacity="0"
                            Scale="0">
                        <Button.Shadow>
                            <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.25"/>
                        </Button.Shadow>
                    </Button>

                    <!-- Next Perek Button -->
                    <Button x:Name="NextPerekButton"
                            Text="â†"
                            FontSize="20"
                            WidthRequest="48"
                            HeightRequest="48"
                            CornerRadius="24"
                            BackgroundColor="{StaticResource PrimaryDark}"
                            TextColor="White"
                            Command="{Binding LoadNextCommand}"
                            Clicked="OnMenuItemClicked"
                            HorizontalOptions="Center"
                            VerticalOptions="End"
                            Margin="0,0,0,30"
                            Opacity="0"
                            Scale="0">
                        <Button.Shadow>
                            <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.25"/>
                        </Button.Shadow>
                    </Button>
                </Grid>
            </AbsoluteLayout>
        </Grid>
    </Grid>

</ContentPage>
