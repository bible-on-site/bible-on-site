<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             x:Class="BibleOnSite.Pages.PerekPage"
             x:DataType="viewmodels:PerekViewModel"
             Title="{Binding Source}"
             FlowDirection="RightToLeft">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="SelectedPasukBackground">#E3F2FD</Color>
            <Color x:Key="SelectedPasukBackgroundDark">#1E3A5F</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <!-- Perek Text - Pasukim List -->
        <CollectionView Grid.Row="0"
                        x:Name="PasukimCollection"
                        ItemsSource="{Binding Perek.Pasukim}"
                        SelectionMode="None"
                        Margin="8,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Pasuk">
                    <Border Padding="12,8"
                            Margin="0,4"
                            StrokeShape="RoundRectangle 8"
                            Stroke="Transparent"
                            x:Name="PasukBorder"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnPasukTapped"
                                                  CommandParameter="{Binding PasukNum}"/>
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="40,*">
                            <Grid.GestureRecognizers>
                                <PointerGestureRecognizer PointerPressed="OnPasukPointerPressed"
                                                          PointerReleased="OnPasukPointerReleased"/>
                            </Grid.GestureRecognizers>
                            <Label Grid.Column="0"
                                   Text="{Binding PasukNumHeb}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   VerticalTextAlignment="Start"
                                   TextColor="{StaticResource Primary}"/>
                            <Label Grid.Column="1"
                                   AutomationId="PasukText"
                                   Text="{Binding Text}"
                                   FontSize="18"
                                   LineBreakMode="WordWrap"
                                   LineHeight="1.4"
                                   HorizontalTextAlignment="End"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Padding="20">
                    <Label Text="טוען..."
                           AutomationId="PerekLoadingLabel"
                           FontSize="18"
                           HorizontalTextAlignment="Center"/>
                    <ActivityIndicator IsRunning="True"
                                       Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Bottom Navigation Bar -->
        <Grid Grid.Row="1"
              ColumnDefinitions="*,*,*"
              Padding="8"
              BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}">
            <Button Grid.Column="0"
                    Text="הקודם"
                    Command="{Binding LoadPreviousCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"/>
            <Label Grid.Column="1"
                   Text="{Binding PerekId, StringFormat='{0}/929'}"
                   FontSize="14"
                   VerticalTextAlignment="Center"
                   HorizontalTextAlignment="Center"/>
            <Button Grid.Column="2"
                    Text="הבא"
                    Command="{Binding LoadNextCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"/>
        </Grid>
    </Grid>

</ContentPage>
