<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:BibleOnSite.ViewModels"
             xmlns:models="clr-namespace:BibleOnSite.Models"
             xmlns:controls="clr-namespace:BibleOnSite.Controls"
             xmlns:behaviors="clr-namespace:BibleOnSite.Behaviors"
             xmlns:converters="clr-namespace:BibleOnSite.Converters"
             xmlns:fonts="clr-namespace:Fonts"
             x:Class="BibleOnSite.Pages.PerekPage"
             x:Name="PerekPageRoot"
             x:DataType="viewmodels:PerekViewModel"
             Title="{Binding Source}"
             FlowDirection="RightToLeft">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="SelectedPasukBackground">#E3F2FD</Color>
            <Color x:Key="SelectedPasukBackgroundDark">#1E3A5F</Color>
            <converters:IntEqualityConverter x:Key="IntEqualityConverter"/>
            <converters:PerushCheckedConverter x:Key="PerushCheckedConverter"/>
            <!-- DataTrigger helper for selection background -->
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid x:Name="MainGrid">

        <!-- Exit Full Screen Button (floating, hidden by default) -->
        <!-- Gesture recognizers are set up in code-behind: native Android touch for
             pixel-perfect drag tracking, MAUI gesture recognizers for other platforms. -->
        <Border x:Name="ExitFullScreenButton"
                WidthRequest="48"
                HeightRequest="48"
                StrokeShape="RoundRectangle 24"
                BackgroundColor="{StaticResource Primary}"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="16,16,16,100"
                IsVisible="False"
                ZIndex="100">
            <Border.Shadow>
                <Shadow Brush="Black"
                        Offset="0,3"
                        Radius="6"
                        Opacity="0.3"/>
            </Border.Shadow>
            <Label Text="{x:Static fonts:FluentUI.full_screen_minimize_24_regular}"
                   FontFamily="FluentIcons"
                   FontSize="24"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HorizontalTextAlignment="Center"
                   VerticalTextAlignment="Center"/>
        </Border>

        <!-- Main Content Area - fills entire viewport -->
        <Grid x:Name="ContentArea"
              ZIndex="0"
              RowDefinitions="Auto,Auto,*">

            <!-- Selection Bar (Row 0 - hidden by default) -->
            <Grid Grid.Row="0"
                  x:Name="SelectionBar"
                  AutomationId="SelectionBar"
                  IsVisible="False"
                  BackgroundColor="{StaticResource Primary}"
                  Padding="4,5"
                  ColumnDefinitions="Auto,Auto,*,Auto,Auto">
                <Grid.HeightRequest>
                    <OnPlatform x:TypeArguments="x:Double" Default="48">
                        <On Platform="Android,iOS" Value="56"/>
                    </OnPlatform>
                </Grid.HeightRequest>
                <!-- Back button -->
                <Button Grid.Column="0"
                        x:Name="SelectionBackButton"
                        AutomationId="SelectionBackButton"
                        Text="{x:Static fonts:FluentUI.arrow_right_24_regular}"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionBackClicked"/>
                <!-- Badge with count -->
                <Border Grid.Column="1"
                        BackgroundColor="White"
                        StrokeShape="RoundRectangle 12"
                        Stroke="Transparent"
                        Padding="8,2"
                        MinimumWidthRequest="24"
                        HeightRequest="24"
                        VerticalOptions="Center"
                        Margin="4,0">
                    <Label x:Name="SelectionCountLabel"
                           AutomationId="SelectionCountLabel"
                           Text="0"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"
                           HorizontalTextAlignment="Center"
                           VerticalTextAlignment="Center"/>
                </Border>
                <!-- Spacer (transparent) -->
                <ContentView Grid.Column="2"/>
                <!-- Share button -->
                <Button Grid.Column="3"
                        AutomationId="SelectionShareButton"
                        Text="{x:Static fonts:FluentUI.share_24_regular}"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionShareClicked"/>
                <!-- Copy button -->
                <Button Grid.Column="4"
                        x:Name="SelectionCopyButton"
                        AutomationId="SelectionCopyButton"
                        Text="{x:Static fonts:FluentUI.copy_20_regular}"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        Clicked="OnSelectionCopyClicked"/>
            </Grid>

            <!-- Loading overlay â€” shown while CarouselView initialises its 929-item
                 adapter.  Uses a native ActivityIndicator which animates on the GPU
                 even when the main thread is blocked by the CarouselView layout pass. -->
            <Grid x:Name="CarouselLoadingOverlay"
                  Grid.Row="1" Grid.RowSpan="2"
                  IsVisible="True"
                  ZIndex="10"
                  BackgroundColor="{AppThemeBinding Light=White, Dark=#1C1C1E}">
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12">
                    <ActivityIndicator IsRunning="True"
                                       Color="{StaticResource Primary}"
                                       HeightRequest="48"
                                       WidthRequest="48"/>
                    <Label Text="×ž×ª×—×‘×¨ ×œ×¤×¨×§..."
                           FontSize="18"
                           HorizontalTextAlignment="Center"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray200}}"/>
                </VerticalStackLayout>
            </Grid>

            <!-- CarouselView for page-based swipe navigation (Row 1 + Row 2) -->
            <!-- Each carousel page contains header + full perek view (pasukim CollectionView) -->
            <CarouselView Grid.Row="1"
                          Grid.RowSpan="2"
                          x:Name="PerekCarousel"
                          ItemsSource="{Binding CarouselPerakim}"
                          CurrentItem="{Binding CurrentCarouselPerek, Mode=TwoWay}"
                          Position="{Binding CarouselPosition, Mode=TwoWay}"
                          CurrentItemChanged="OnCarouselItemChanged"
                          Loop="False"
                          PeekAreaInsets="1"
                          Margin="0">
                <CarouselView.ItemTemplate>
                    <DataTemplate x:DataType="models:Perek">
                        <!-- Full perek page: header + CollectionView of pasukim -->
                        <Grid RowDefinitions="Auto,*">
                            <!-- Perek Header (Row 0) -->
                            <Label Grid.Row="0"
                                   Text="{Binding Header}"
                                   FontSize="22"
                                   FontAttributes="Bold"
                                   HorizontalTextAlignment="Center"
                                   Padding="16,12"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"/>

                            <!-- Perek Text - Pasukim List (Row 1) with perushim inline -->
                            <CollectionView Grid.Row="1"
                                            x:Name="PasukimCollection"
                                            ItemsSource="{Binding Pasukim}"
                                            SelectionMode="None"
                                            Scrolled="OnPasukimScrolled"
                                            Margin="8,0,8,0">
                                <CollectionView.Footer>
                                    <ContentView x:Name="PasukimFooterSpacer" HeightRequest="90" BackgroundColor="Transparent"/>
                                </CollectionView.Footer>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:Pasuk">
                                        <Border Padding="12,8"
                                                Margin="0,4"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                x:Name="PasukBorder"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                            <Border.FlowDirection>
                                                <OnPlatform x:TypeArguments="FlowDirection">
                                                    <On Platform="iOS" Value="RightToLeft"/>
                                                    <On Platform="MacCatalyst" Value="RightToLeft"/>
                                                </OnPlatform>
                                            </Border.FlowDirection>
                                            <Border.Triggers>
                                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                                    <Setter Property="BackgroundColor" Value="{StaticResource SelectedPasukBackground}"/>
                                                </DataTrigger>
                                            </Border.Triggers>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnPasukTapped"
                                                                      CommandParameter="{Binding PasukNum}"/>
                                                <TapGestureRecognizer Tapped="OnPasukRightClicked"
                                                                      CommandParameter="{Binding PasukNum}"
                                                                      Buttons="Secondary"/>
                                                <PointerGestureRecognizer PointerPressed="OnPasukPointerPressed"
                                                                          PointerReleased="OnPasukPointerReleased"/>
                                            </Border.GestureRecognizers>
                                            <Border.Behaviors>
                                                <behaviors:LongPressBehavior LongPressDuration="600"
                                                                             LongPressed="OnPasukLongPressed"
                                                                             NativeTapped="OnPasukNativeTapped"/>
                                            </Border.Behaviors>
                                            <Grid ColumnDefinitions="40,*">
                                                <Label Grid.Column="0"
                                                       Text="{Binding PasukNumHeb}"
                                                       FontSize="{DynamicResource PasukNumFontSize}"
                                                       FontAttributes="Bold"
                                                       VerticalTextAlignment="Start"
                                                       Margin="0,1.5,0,0"
                                                       TextColor="{StaticResource Primary}"/>
                                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                    <Label AutomationId="PasukText"
                                                           FormattedText="{Binding FormattedText}"
                                                           FontSize="{DynamicResource PasukFontSize}"
                                                           LineBreakMode="WordWrap"
                                                           LineHeight="1.4"/>
                                                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding PerushNotes}"
                                                                         Spacing="2"
                                                                         Margin="0,4,0,0">
                                                        <BindableLayout.ItemTemplate>
                                                            <DataTemplate x:DataType="models:PerushNoteDisplay">
                                                                <VerticalStackLayout Spacing="2">
                                                                    <Label Text="{Binding PerushName}"
                                                                           FontSize="{DynamicResource PerushNameFontSize}"
                                                                           FontAttributes="Bold"
                                                                           TextColor="{StaticResource Primary}"/>
                                                                    <controls:HtmlView HtmlContent="{Binding DisplayContent}"
                                                                                      FontSize="{DynamicResource PerushContentFontSize}"
                                                                                      TextAlignment="Justify"
                                                                                      TextDirection="Rtl"
                                                                                      LineHeight="1.4"/>
                                                                </VerticalStackLayout>
                                                            </DataTemplate>
                                                        </BindableLayout.ItemTemplate>
                                                    </VerticalStackLayout>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <VerticalStackLayout VerticalOptions="Center"
                                                         HorizontalOptions="Center"
                                                         Padding="20">
                                        <Image Source="loading_book_anim.gif"
                                               IsAnimationPlaying="True"
                                               HeightRequest="60"
                                               WidthRequest="60"
                                               Aspect="AspectFit"/>
                                        <Label Text="×ž×ª×—×‘×¨ ×œ×¤×¨×§..."
                                               AutomationId="PerekLoadingLabel"
                                               FontSize="18"
                                               HorizontalTextAlignment="Center"
                                               Margin="0,10,0,0"/>
                                    </VerticalStackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </Grid>
                    </DataTemplate>
                </CarouselView.ItemTemplate>
            </CarouselView>

            <!-- Articles View (hidden by default, shown when articles button clicked) -->
            <!-- Uses shared ArticleCard component -->
            <CollectionView Grid.Row="2"
                            x:Name="ArticlesCollection"
                            IsVisible="False"
                            SelectionMode="Single"
                            SelectionChanged="OnArticleSelected"
                            Margin="8,8,8,0">
                <!-- Footer spacer so last item can scroll above bottom bar -->
                <CollectionView.Footer>
                    <ContentView x:Name="ArticlesFooterSpacer" HeightRequest="90" BackgroundColor="Transparent"/>
                </CollectionView.Footer>
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="2"
                                     HorizontalItemSpacing="8"
                                     VerticalItemSpacing="8"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Article">
                        <Border Padding="0"
                                StrokeShape="RoundRectangle 12"
                                Stroke="Transparent"
                                BackgroundColor="Transparent">
                                <Border.Triggers>
                                <DataTrigger TargetType="Border" Value="True">
                                    <DataTrigger.Binding>
                                        <MultiBinding Converter="{StaticResource IntEqualityConverter}">
                                            <Binding Path="Id"/>
                                            <Binding Source="{x:Reference PerekPageRoot}" Path="SelectedArticleId"/>
                                        </MultiBinding>
                                    </DataTrigger.Binding>
                                    <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light={StaticResource SelectedPasukBackground}, Dark={StaticResource SelectedPasukBackgroundDark}}"/>
                                </DataTrigger>
                            </Border.Triggers>
                            <controls:ArticleCard Article="{Binding .}"/>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="20">
                        <Label Text="××™×Ÿ ×ž××ž×¨×™× ×œ×¤×¨×§ ×–×”"
                               FontSize="18"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- Perushim Panel (slides up from bottom, above content but behind bottom bar) -->
        <Border x:Name="PerushimPanel"
                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                StrokeShape="RoundRectangle 16,16,0,0"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                VerticalOptions="End"
                ZIndex="50"
                IsVisible="False">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,-3" Radius="8" Opacity="0.2"/>
            </Border.Shadow>
            <Grid RowDefinitions="Auto,*" Padding="16,12,16,0">
                <!-- Header with drag handle - draggable to dismiss -->
                <VerticalStackLayout x:Name="PerushimDragHandle" Grid.Row="0" Spacing="4">
                    <VerticalStackLayout.GestureRecognizers>
                        <PanGestureRecognizer PanUpdated="OnPerushimPanelPan"/>
                    </VerticalStackLayout.GestureRecognizers>
                    <!-- Drag handle indicator -->
                    <BoxView WidthRequest="40"
                             HeightRequest="4"
                             CornerRadius="2"
                             BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray500}}"
                             HorizontalOptions="Center"
                             Margin="0,0,0,4"/>
                    <!-- Title -->
                    <Label Text="×¤×™×¨×•×©×™×"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"/>
                    <!-- Divider -->
                    <BoxView HeightRequest="1"
                             BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                             Margin="0,4,0,0"/>
                </VerticalStackLayout>
                <!-- Scrollable content area for perushim list -->
                <ScrollView Grid.Row="1" Margin="0,8,0,90">
                    <CollectionView x:Name="PerushimCollection"
                                   ItemsSource="{Binding Perushim}"
                                   SelectionMode="None"
                                   VerticalOptions="Start">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Perush">
                                <Grid Padding="4,2" ColumnDefinitions="Auto,*" x:Name="PerushRow">
                                    <CheckBox Grid.Column="0"
                                              VerticalOptions="Center"
                                              Margin="0,0,8,0"
                                              CheckedChanged="OnPerushCheckboxChanged">
                                        <CheckBox.IsChecked>
                                            <MultiBinding Converter="{StaticResource PerushCheckedConverter}" Mode="OneWay">
                                                <Binding Path="Id"/>
                                                <Binding Path="BindingContext.CheckedPerushim" Source="{x:Reference PerekPageRoot}"/>
                                            </MultiBinding>
                                        </CheckBox.IsChecked>
                                    </CheckBox>
                                    <Label Grid.Column="1"
                                           Text="{Binding Name}"
                                           FontSize="16"
                                           VerticalOptions="Center"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="8"
                                                 Padding="0,16,0,0">
                                <Label Text="ðŸ“š"
                                       FontSize="32"
                                       HorizontalTextAlignment="Center"/>
                                <Label Text="{Binding PerushimEmptyMessage}"
                                       FontSize="14"
                                       HorizontalTextAlignment="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                                <Button x:Name="DownloadPerushimButton"
                                        Text="×œ×”×•×¨×™×“ ×¤×™×¨×•×©×™×"
                                        IsVisible="{Binding ShowDownloadPerushimButton}"
                                        Clicked="OnDownloadPerushimClicked"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </ScrollView>
            </Grid>
        </Border>

        <!-- Bottom Navigation Bar with Circular Menu - OVERLAY floating at bottom -->
        <Grid x:Name="BottomBar"
              HeightRequest="90"
              VerticalOptions="End"
              ZIndex="100"
              BackgroundColor="Transparent">
            <!-- Background shape with notch - content shows through the notch -->
            <AbsoluteLayout BackgroundColor="Transparent">
                <GraphicsView x:Name="BottomBarBackground"
                              AbsoluteLayout.LayoutBounds="0,0,1,1"
                              AbsoluteLayout.LayoutFlags="All"
                              BackgroundColor="Transparent"
                              Drawable="{StaticResource BottomBarDrawable}"/>

                <!-- Bottom bar buttons - evenly distributed (RTL: 20%=right, 80%=left) -->
                <!-- Original order from right to left: Chevron, Text, Articles, FullScreen -->

                <!-- Perushim Chevron Button at 8% -->
                <Button x:Name="PerushimChevronButton"
                        Text="{x:Static fonts:FluentUI.chevron_up_24_regular}"
                        FontFamily="FluentIcons"
                        FontSize="20"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnPerushimChevronClicked"
                        AbsoluteLayout.LayoutBounds="0.08,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

                <!-- Text Button at 28% - vertical × ×‘ ×’ -->
                <Button x:Name="TextButton"
                        Text="×&#x0a;×‘&#x0a;×’"
                        FontSize="10"
                        FontAttributes="Bold"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        LineBreakMode="WordWrap"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnTextButtonClicked"
                        AbsoluteLayout.LayoutBounds="0.28,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

                <!-- Articles Button with Badge at 72% -->
                <Grid WidthRequest="50"
                      HeightRequest="44"
                      AbsoluteLayout.LayoutBounds="0.72,0.55"
                      AbsoluteLayout.LayoutFlags="PositionProportional">
                    <Button x:Name="ArticlesButton"
                            Text="{x:Static fonts:FluentUI.document_24_regular}"
                            FontFamily="FluentIcons"
                            FontSize="20"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            Clicked="OnArticlesButtonClicked"
                            HorizontalOptions="Center"/>
                    <!-- Badge (red, on top of button) -->
                    <Border x:Name="ArticlesBadge"
                            BackgroundColor="#E53935"
                            StrokeShape="RoundRectangle 10"
                            Stroke="Transparent"
                            Padding="4,1"
                            MinimumWidthRequest="16"
                            HorizontalOptions="Center"
                            VerticalOptions="Start"
                            Margin="8,-2,0,0"
                            IsVisible="False">
                        <Label Text="{Binding ArticlesCount}"
                               FontSize="11"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalTextAlignment="Center"
                               VerticalTextAlignment="Center"/>
                    </Border>
                </Grid>

                <!-- Full Screen Button at 92% -->
                <Button x:Name="FullScreenButton"
                        Text="{x:Static fonts:FluentUI.full_screen_maximize_24_regular}"
                        FontFamily="FluentIcons"
                        FontSize="22"
                        WidthRequest="44"
                        HeightRequest="44"
                        Padding="0"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                        Clicked="OnFullScreenClicked"
                        AbsoluteLayout.LayoutBounds="0.92,0.55"
                        AbsoluteLayout.LayoutFlags="PositionProportional"/>

            </AbsoluteLayout>
        </Grid>

        <!-- Satellite buttons overlay - uses AbsoluteLayout for precise positioning -->
        <AbsoluteLayout x:Name="FloatingMenuContainer"
                        ZIndex="150"
                        InputTransparent="True"
                        CascadeInputTransparent="False"
                        BackgroundColor="Transparent">

            <!-- 4 satellite buttons - fan out from center -->

            <!-- Previous perek (bottom-left satellite). Disabled at perek 1 via Command.CanExecute. -->
            <Button x:Name="PrevPerekButton"
                    Text="{x:Static fonts:FluentUI.document_arrow_right_24_regular}"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadPreviousCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.26,0.91,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Today's perek (top-left satellite) -->
            <!-- Icon: calendar_date_24_regular (calendar with date) via x:Static for 5-digit Unicode -->
            <Button x:Name="TodayButton"
                    Text="{x:Static fonts:FluentUI.calendar_date_24_regular}"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadTodayCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.42,0.87,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Perek Picker (top-right satellite) -->
            <Button x:Name="PerekPickerButton"
                    Text="{x:Static fonts:FluentUI.library_24_regular}"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Clicked="OnPerekPickerClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.58,0.87,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Next perek (bottom-right satellite). Disabled at perek 929 via Command.CanExecute. -->
            <Button x:Name="NextPerekButton"
                    Text="{x:Static fonts:FluentUI.document_arrow_right_24_regular}"
                    FontFamily="FluentIcons"
                    FontSize="22"
                    ScaleX="-1"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BackgroundColor="{StaticResource PrimaryDark}"
                    TextColor="White"
                    Command="{Binding LoadNextCommand}"
                    Clicked="OnMenuItemClicked"
                    Opacity="0"
                    InputTransparent="True"
                    AbsoluteLayout.LayoutBounds="0.74,0.91,48,48"
                    AbsoluteLayout.LayoutFlags="PositionProportional"/>

            <!-- Center Circular FAB - placed last to be on top, sits in notch -->
            <Button x:Name="CircularMenuButton"
                    Text="â˜°"
                    FontSize="22"
                    WidthRequest="56"
                    HeightRequest="56"
                    CornerRadius="28"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    Clicked="OnCircularMenuClicked"
                    AbsoluteLayout.LayoutBounds="0.5,0.95,56,56"
                    AbsoluteLayout.LayoutFlags="PositionProportional">
                <Button.Shadow>
                    <Shadow Brush="Black"
                            Offset="0,3"
                            Radius="6"
                            Opacity="0.3"/>
                </Button.Shadow>
            </Button>
        </AbsoluteLayout>

        <!-- Perek Picker Popup Overlay -->
        <controls:PerekPickerPopup x:Name="PerekPickerPopup"
                                   ZIndex="200"
                                   PerekSelected="OnPerekPickerSelected"/>
    </Grid>

</ContentPage>
