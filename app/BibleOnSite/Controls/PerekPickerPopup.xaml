<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:BibleOnSite.Controls"
             x:Class="BibleOnSite.Controls.PerekPickerPopup"
             x:Name="PickerPopup"
             IsVisible="False"
             FlowDirection="RightToLeft">

    <!-- Popup container -->
    <Grid>
        <!-- Semi-transparent background for tap to dismiss -->
        <BoxView BackgroundColor="#80000000"
                 InputTransparent="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBackgroundTapped"/>
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Picker container: from below perek header to above satellite buttons -->
        <Border Stroke="{StaticResource Primary}"
                StrokeThickness="1"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}"
                Padding="0"
                Margin="16,55,16,130"
                VerticalOptions="Fill"
                HorizontalOptions="Fill"
                InputTransparent="False">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12"/>
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,*,Auto">
                <!-- Header -->
                <Border Grid.Row="0"
                        BackgroundColor="{StaticResource Primary}"
                        Padding="16,12">
                    <Label Text="בחירת פרק"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalTextAlignment="Center"/>
                </Border>

                <!-- Three-column picker -->
                <Grid Grid.Row="1"
                      ColumnDefinitions="*,1.2*,0.7*"
                      Padding="8"
                      ColumnSpacing="6"
                      RowDefinitions="Auto,*"
                      RowSpacing="4">

                    <!-- Column headers -->
                    <Label Grid.Row="0" Grid.Column="0"
                           Text="קטגוריה"
                           FontSize="12"
                           TextColor="{StaticResource Gray500}"
                           HorizontalTextAlignment="Center"/>
                    <Label Grid.Row="0" Grid.Column="1"
                           Text="ספר"
                           FontSize="12"
                           TextColor="{StaticResource Gray500}"
                           HorizontalTextAlignment="Center"/>
                    <Label Grid.Row="0" Grid.Column="2"
                           Text="פרק"
                           FontSize="12"
                           TextColor="{StaticResource Gray500}"
                           HorizontalTextAlignment="Center"/>

                    <!-- Column 1: Sefer Groups (Torah, Neviim, Ketuvim) -->
                    <Border Grid.Row="1" Grid.Column="0"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2E}"
                            Padding="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <CollectionView x:Name="SeferGroupList"
                                        SelectionMode="Single"
                                        SelectionChanged="OnSeferGroupSelected"
                                        HeightRequest="300"
                                        ItemSizingStrategy="MeasureAllItems"
                                        InputTransparent="False">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="0"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,12">
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal"/>
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                        <Label Text="{Binding Name}"
                                               FontSize="16"
                                               HorizontalTextAlignment="Center"
                                               VerticalTextAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Border>

                    <!-- Column 2: Sefarim within group -->
                    <Border Grid.Row="1" Grid.Column="1"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2E}"
                            Padding="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <CollectionView x:Name="SeferList"
                                        SelectionMode="Single"
                                        SelectionChanged="OnSeferSelected"
                                        HeightRequest="300"
                                        ItemSizingStrategy="MeasureAllItems"
                                        InputTransparent="False">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="0"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,12">
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal"/>
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                        <Label Text="{Binding DisplayName}"
                                               FontSize="14"
                                               HorizontalTextAlignment="Center"
                                               VerticalTextAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Border>

                    <!-- Column 3: Perakim within sefer -->
                    <Border Grid.Row="1" Grid.Column="2"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2E}"
                            Padding="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <CollectionView x:Name="PerekList"
                                        SelectionMode="Single"
                                        SelectionChanged="OnPerekSelected"
                                        HeightRequest="300"
                                        ItemSizingStrategy="MeasureAllItems"
                                        InputTransparent="False">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="0"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,10">
                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal"/>
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                        <Label Text="{Binding DisplayText}"
                                               FontSize="14"
                                               HorizontalTextAlignment="Center"
                                               VerticalTextAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Border>
                </Grid>

                <!-- Footer buttons -->
                <Grid Grid.Row="2"
                      ColumnDefinitions="*,*"
                      Padding="12"
                      ColumnSpacing="12">
                    <Button Grid.Column="0"
                            Text="בטל"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Gray600}"
                            BorderColor="{StaticResource Gray400}"
                            BorderWidth="1"
                            CornerRadius="8"
                            Clicked="OnCancelClicked"/>
                    <Button Grid.Column="1"
                            x:Name="ConfirmButton"
                            Text="בחר"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            CornerRadius="8"
                            IsEnabled="False"
                            Clicked="OnConfirmClicked"/>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</ContentView>
