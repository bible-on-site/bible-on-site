[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true

[config]
default_to_workspace = false

# =============================================================================
# Common Tasks
# =============================================================================

[tasks.build]
description = "Build all data processing tools"
command = "cargo"
args = ["build", "--release"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

[tasks.lint]
description = "Run clippy linter"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.fmt]
description = "Format code"
command = "cargo"
args = ["fmt", "--all"]

[tasks.fmt-check]
description = "Check code formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

# =============================================================================
# Sefaria Setup Tasks
# =============================================================================

[tasks.sefaria-setup]
description = "Check MongoDB installation and setup environment"
cwd = "./sefaria/setup-and-population"
command = "cargo"
args = ["run", "--release", "--", "setup"]

[tasks.sefaria-populate]
description = "Populate MongoDB with Sefaria dump"
cwd = "./sefaria/setup-and-population"
command = "cargo"
args = ["run", "--release", "--", "populate"]

# =============================================================================
# Pipeline Tasks
# =============================================================================

[tasks.generate-tanah-view]
description = "Generate tanah view from MongoDB (use --json or --sqlite)"
cwd = "./sefaria/pipelines/tanah-view"
script = '''
echo "Usage: cargo make generate-tanah-view-json OR cargo make generate-tanah-view-sqlite"
'''

[tasks.generate-tanah-view-json]
description = "Generate tanah view as JSON"
cwd = "./sefaria/pipelines/tanah-view"
command = "cargo"
args = ["run", "--release", "--", "--format", "json"]

[tasks.generate-tanah-view-sqlite]
description = "Generate tanah view as SQLite"
cwd = "./sefaria/pipelines/tanah-view"
command = "cargo"
args = ["run", "--release", "--", "--format", "sqlite"]

[tasks.generate-compass-stages]
description = "Generate MongoDB Compass stages for debugging aggregation pipeline"
cwd = "./sefaria/pipelines/tanah-view"
command = "cargo"
args = ["run", "--release", "--", "--format", "compass-stages"]

[tasks.generate-tanah-view-mysql]
description = "Generate tanah view as MySQL SQL file"
cwd = "./sefaria/pipelines/tanah-view"
command = "cargo"
args = [
    "run",
    "--release",
    "--",
    "--format",
    "mysql",
    "--output-to-dependant-modules",
]

# =============================================================================
# S3 Tasks
# =============================================================================

[tasks.s3-populate]
description = "Populate S3 bucket with test data (uses S3_* env vars)"
cwd = "./s3/s3-populator"
command = "cargo"
args = ["run", "--release"]

[tasks.s3-populate-dev]
description = "Populate S3 bucket with dev environment"
cwd = "./s3/s3-populator"
env = { "S3_ENDPOINT" = "http://localhost:4566", "S3_ACCESS_KEY_ID" = "test", "S3_SECRET_ACCESS_KEY" = "test" }
command = "cargo"
args = ["run", "--release"]

[tasks.s3-populate-test]
description = "Populate S3 bucket with test environment"
cwd = "./s3/s3-populator"
env = { "S3_ENDPOINT" = "http://localhost:4566", "S3_ACCESS_KEY_ID" = "test", "S3_SECRET_ACCESS_KEY" = "test", "S3_BUCKET" = "bible-on-site-rabbis-test" }
command = "cargo"
args = ["run", "--release"]

[tasks.s3-clear]
description = "Clear S3 bucket (uses S3_* env vars)"
cwd = "./s3/s3-populator"
command = "cargo"
args = ["run", "--release", "--", "--clear-only"]

# =============================================================================
# MySQL Tasks
# =============================================================================

[tasks.mysql-populate]
description = "Populate MySQL database with Tanah structure and test data"
cwd = "./mysql/db-populator"
command = "cargo"
args = ["run", "--release"]

[tasks.mysql-populate-dev]
description = "Populate MySQL dev database (tanah)"
env_files = [".dev.env"]
cwd = "./mysql/db-populator"
command = "cargo"
args = ["run", "--release"]

[tasks.mysql-populate-test]
description = "Populate MySQL test database (tanah_test)"
env_files = [".test.env"]
cwd = "./mysql/db-populator"
command = "cargo"
args = ["run", "--release"]

[tasks.mysql-drop]
description = "Drop the MySQL test database (for clean state testing)"
cwd = "./mysql/db-populator"
command = "cargo"
args = ["run", "--release", "--", "--drop-only"]

[tasks.mysql-populate-data-only]
description = "Populate MySQL database with test data only (skip structure)"
cwd = "./mysql/db-populator"
command = "cargo"
args = ["run", "--release", "--", "--skip-structure"]

[tasks.dev]
description = "Dev target: populate dev DB"
dependencies = ["mysql-populate-dev"]

[tasks.test]
description = "Test target: populate test DB"
dependencies = ["mysql-populate-test"]

# =============================================================================
# Unit Test Tasks
# =============================================================================

[tasks.test-unit-dir-create]
description = "Create JUnit report output directory"
command = "mkdir"
args = ["-p", ".junit-report/unit"]

[tasks.test-unit]
description = "Run all unit tests"
command = "cargo"
args = ["test", "--workspace"]

[tasks.test-unit-junit]
description = "Run all unit tests with JUnit output"
dependencies = ["test-unit-dir-create"]
command = "cargo"
args = ["nextest", "run", "--workspace", "--profile", "ci"]

# =============================================================================
# Integration Test Tasks
# =============================================================================

[tasks.test-integration-dir-create]
description = "Create integration test JUnit report output directory"
command = "mkdir"
args = ["-p", ".junit-report/integration"]

[tasks.test-integration]
description = "Run integration tests (requires MongoDB with Sefaria dump)"
command = "cargo"
args = ["test", "--workspace", "--features", "integration"]

[tasks.test-integration-junit]
description = "Run integration tests with JUnit output"
dependencies = ["test-integration-dir-create"]
command = "cargo"
args = [
    "nextest",
    "run",
    "--workspace",
    "--features",
    "integration",
    "--profile",
    "ci-integration",
]

# =============================================================================
# Coverage Tasks (tanah-view)
# =============================================================================

[tasks.coverage-dir-create]
description = "Create coverage output directory"
cwd = "./sefaria/pipelines/tanah-view"
command = "mkdir"
args = ["-p", ".coverage"]

[tasks.coverage-tanah-view]
description = "Run tanah-view tests with coverage and generate lcov.info"
cwd = "./sefaria/pipelines/tanah-view"
dependencies = ["coverage-dir-create"]
command = "cargo"
args = ["llvm-cov", "--lcov", "--output-path", ".coverage/lcov.info"]

[tasks.coverage-tanah-view-browser]
description = "Run tanah-view tests with coverage and open HTML report in browser"
condition = { env_not_set = ["CI"] }
cwd = "./sefaria/pipelines/tanah-view"
command = "cargo"
args = ["llvm-cov", "--html", "--open"]
