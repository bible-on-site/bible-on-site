# Use VPC DNS resolver for Cloud Map service discovery
resolver 172.31.0.2 valid=10s ipv6=off;

# Sensitive Information Restoration:
# <API_SERVER_IP>: External API IP - Check external service configuration

upstream api {
    # TODO: Replace with api.bible-on-site.local when API service is deployed
    server <API_SERVER_IP>:3003;
    server <API_SERVER_IP>:3003 backup;
}

server {
    listen 80;
    server_name xn--febl3a.co.il תנך.co.il xn--febl3a.com תנך.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name xn--febl3a.co.il תנך.co.il;
    ssl_certificate     /etc/letsencrypt/live/xn--febl3a.co.il/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--febl3a.co.il/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
         set $website_backend "website.bible-on-site.local";
         proxy_pass http://$website_backend:3000$request_uri;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-Proto https;
         proxy_ssl_server_name on;
         proxy_ssl_verify off;
    }

    # Serve static files from www directory
    location /www/ {
        alias /var/www/html/;
        autoindex on;
        try_files $uri $uri/ =404;
    }
}

server {
    listen 443 ssl;
    server_name xn--febl3a.com תנך.com;
    ssl_certificate     /etc/letsencrypt/live/xn--febl3a.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--febl3a.com/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
         set $website_backend "website.bible-on-site.local";
         proxy_pass http://$website_backend:3000$request_uri;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-Proto https;
         proxy_ssl_server_name on;
         proxy_ssl_verify off;
    }

    # Serve static files from www directory
    location /www/ {
        alias /var/www/html/;
        autoindex on;
        try_files $uri $uri/ =404;
    }
}


server {
    listen 80;
    server_name api.xn--febl3a.co.il api.תנך.co.il api.xn--febl3a.com api.תנך.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name api.xn--febl3a.co.il api.תנך.co.il;
    ssl_certificate     /etc/letsencrypt/live/xn--febl3a.co.il/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--febl3a.co.il/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
         proxy_pass http://api$request_uri;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-Proto https;
         proxy_ssl_server_name on;
         proxy_ssl_verify off;
    }
}


server {
    listen 443 ssl;
    server_name api.xn--febl3a.com api.תנך.com;
    ssl_certificate     /etc/letsencrypt/live/xn--febl3a.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--febl3a.com/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
         proxy_pass http://api$request_uri;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-Proto https;
         proxy_ssl_server_name on;
         proxy_ssl_verify off;
    }
}
