# ============================================================================
# ⚠️ DISCLAIMER: This CloudFormation template has NEVER been tested or deployed.
# It is maintained as Infrastructure as Code DOCUMENTATION ONLY to reflect the
# de-facto AWS configuration. Do not assume it will work without thorough testing.
# ============================================================================

AWSTemplateFormatVersion: "2010-09-09"
Description: |
  Lambda function for deploying SQL data to RDS MySQL.

  ⚠️ WARNING: This template is DOCUMENTATION ONLY and has never been deployed.

  This Lambda runs in the VPC and can access the RDS MySQL instance.
  It is invoked by GitHub Actions CD workflow to populate the database.

  Lambda code: See data-deploy-lambda.py in this directory.

  Sensitive Information Restoration:
  | Placeholder | Description | Restoration Command |
  |---|---|---|
  | `<RDS_SECURITY_GROUP_ID>` | RDS MySQL security group | `aws ec2 describe-security-groups --filters "Name=group-name,Values=tanah-rds-sg" --query "SecurityGroups[0].GroupId" --output text --region il-central-1` |

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for the Lambda function
    Default: vpc-0d6af72e472db138c

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet IDs for the Lambda function
    Default: subnet-056e95f1b766e6b0d,subnet-02c538ecab687f8bd,subnet-07bf7408f0795eacc

  RDSSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Security group ID for RDS (to allow Lambda access)
    Default: <RDS_SECURITY_GROUP_ID> # tanah-rds-sg

Resources:
  # =============================================================================
  # S3 Bucket for SQL Files
  # =============================================================================
  DataDeployBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: bible-on-site-data-deploy
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldSQLFiles
            Status: Enabled
            ExpirationInDays: 1
      Tags:
        - Key: Project
          Value: bible-on-site
        - Key: Purpose
          Value: data-deploy

  # =============================================================================
  # Security Group for Lambda
  # =============================================================================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: data-deploy-lambda-sg
      GroupDescription: Security group for data deploy Lambda function
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        # Allow HTTPS outbound (for SSM, S3)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for AWS APIs (SSM, S3)
        # Allow MySQL outbound (for RDS)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 172.31.0.0/16
          Description: MySQL access to RDS
      Tags:
        - Key: Project
          Value: bible-on-site
        - Key: Purpose
          Value: data-deploy-lambda

  # =============================================================================
  # IAM Role for Lambda
  # =============================================================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: DataDeployLambdaRole
      Description: Role for data deploy Lambda function
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: DataDeployLambdaPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # SSM Parameter Store - read database credentials
              - Sid: SSMParameterStoreRead
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource:
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/bible-on-site-tanah-db-*"
              # S3 - read SQL files
              - Sid: S3Read
                Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub "arn:aws:s3:::${DataDeployBucket}/*"
      Tags:
        - Key: Project
          Value: bible-on-site
        - Key: Purpose
          Value: data-deploy-lambda

  # =============================================================================
  # Lambda Function
  # =============================================================================
  # ⚠️ NOTE: The actual Lambda is deployed with pymysql bundled.
  # See data-deploy-lambda.py for the source code.
  DataDeployLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: bible-on-site-db-populator
      Description: Populates RDS MySQL database with SQL files from S3
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300 # 5 minutes
      MemorySize: 1024 # Increased from 256 to handle large perushim_data.sql (~33 MB)
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds: !Ref SubnetIds
      Environment:
        Variables:
          S3_BUCKET: !Ref DataDeployBucket
          SSM_PREFIX: bible-on-site-tanah-db
      Code:
        # Deploy using: See data-deploy-lambda.py docstring for instructions
        S3Bucket: bible-on-site-data-deploy
        S3Key: lambda/lambda.zip
      Tags:
        - Key: Project
          Value: bible-on-site
        - Key: Purpose
          Value: data-deploy

  # =============================================================================
  # Update RDS Security Group to Allow Lambda Access
  # =============================================================================
  # Note: This creates an ingress rule on the RDS security group
  # to allow traffic from the Lambda security group
  RDSSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RDSSecurityGroupId
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Description: Allow MySQL access from data deploy Lambda

  # =============================================================================
  # VPC Endpoints (Required for Lambda in VPC to access AWS services)
  # =============================================================================
  # Lambda runs in a private VPC with no NAT Gateway. These endpoints
  # allow the Lambda to reach S3 and SSM without internet access.

  # S3 Gateway Endpoint (free, uses route tables)
  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VpcId
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - rtb-0123456789abcdef0 # Replace with actual route table ID
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !Sub "arn:aws:s3:::${DataDeployBucket}/*"

  # SSM Interface Endpoint (has hourly cost)
  SSMInterfaceEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VpcId
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
      VpcEndpointType: Interface
      SubnetIds: !Ref SubnetIds
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # Security group for VPC Interface Endpoints
  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: vpc-endpoint-sg
      GroupDescription: Security group for VPC interface endpoints
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.31.0.0/16
          Description: HTTPS from VPC CIDR for interface endpoints
      Tags:
        - Key: Project
          Value: bible-on-site

  # Add HTTPS ingress to Lambda SG for VPC endpoint communication
  LambdaSecurityGroupHTTPSIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443
      CidrIp: 172.31.0.0/16
      Description: HTTPS for VPC endpoint communication

Outputs:
  LambdaFunctionArn:
    Description: ARN of the data deploy Lambda function
    Value: !GetAtt DataDeployLambda.Arn
    Export:
      Name: DataDeployLambdaArn

  LambdaFunctionName:
    Description: Name of the data deploy Lambda function
    Value: !Ref DataDeployLambda
    Export:
      Name: DataDeployLambdaName

  S3BucketName:
    Description: S3 bucket for SQL files
    Value: !Ref DataDeployBucket
    Export:
      Name: DataDeployS3Bucket

  LambdaSecurityGroupId:
    Description: Security group ID for Lambda
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: DataDeployLambdaSecurityGroup
# =============================================================================
# MANUAL SETUP STEPS
# =============================================================================
#
# 1. Create S3 bucket:
#    aws s3 mb s3://bible-on-site-data-deploy --region il-central-1
#
# 2. Create Lambda security group:
#    aws ec2 create-security-group \
#      --group-name data-deploy-lambda-sg \
#      --description "Security group for data deploy Lambda" \
#      --vpc-id vpc-0d6af72e472db138c \
#      --region il-central-1
#
# 3. Add egress rules to Lambda SG (for SSM/S3/RDS)
#
# 4. Add ingress rule to RDS SG to allow Lambda SG
#
# 5. Create IAM role for Lambda with SSM and S3 read permissions
#
# 6. Create Lambda function with pymysql bundled:
#    a. Create deployment package:
#       mkdir lambda-package && cd lambda-package
#       pip install pymysql -t .
#       cp data-deploy-lambda.py index.py
#       zip -r ../lambda.zip .
#    b. Deploy:
#       aws lambda create-function \
#         --function-name bible-on-site-db-populator \
#         --runtime python3.11 \
#         --handler index.handler \
#         --zip-file fileb://lambda.zip \
#         --role <LAMBDA_ROLE_ARN> \
#         --timeout 300 \
#         --memory-size 1024 \
#         --vpc-config SubnetIds=...,SecurityGroupIds=... \
#         --region il-central-1
#
# 7. Create VPC Endpoints (REQUIRED - Lambda in VPC has no internet access):
#    a. S3 Gateway Endpoint (free):
#       aws ec2 create-vpc-endpoint \
#         --vpc-id vpc-0d6af72e472db138c \
#         --service-name com.amazonaws.il-central-1.s3 \
#         --vpc-endpoint-type Gateway \
#         --route-table-ids <ROUTE_TABLE_ID> \
#         --region il-central-1
#
#    b. SSM Interface Endpoint (has hourly cost ~$7/month):
#       aws ec2 create-vpc-endpoint \
#         --vpc-id vpc-0d6af72e472db138c \
#         --service-name com.amazonaws.il-central-1.ssm \
#         --vpc-endpoint-type Interface \
#         --subnet-ids subnet-056e95f1b766e6b0d subnet-02c538ecab687f8bd \
#         --security-group-ids <VPC_ENDPOINT_SG_ID> \
#         --private-dns-enabled \
#         --region il-central-1
#
#    c. Add HTTPS ingress to Lambda SG from VPC CIDR (for endpoint communication)
#
# 8. Update GitHub Actions IAM role to allow:
#    - s3:PutObject on the bucket
#    - lambda:InvokeFunction on the Lambda
#
# =============================================================================
# DEPLOYED RESOURCES (as of January 2026)
# =============================================================================
# - S3 Bucket: bible-on-site-data-deploy
# - Lambda: bible-on-site-db-populator
# - Lambda SG: sg-0cdca171d4f33dd34 (data-deploy-lambda-sg)
# - S3 Gateway Endpoint: vpce-0388b3ea36b6a3214
# - SSM Interface Endpoint: vpce-0dd7903d30e03208c
# =============================================================================
