@startuml AWS Architecture

!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/AWSSimplified.puml
!include AWSPuml/Compute/EC2.puml
!include AWSPuml/Compute/Lambda.puml
!include AWSPuml/Containers/ElasticContainerRegistry.puml
!include AWSPuml/Containers/ElasticContainerService.puml
!include AWSPuml/NetworkingContentDelivery/CloudMap.puml
!include AWSPuml/ApplicationIntegration/EventBridge.puml
!include AWSPuml/General/User.puml
!include AWSPuml/General/Client.puml
!include AWSPuml/General/Mobileclient.puml
!include AWSPuml/DeveloperTools/CodePipeline.puml
!include AWSPuml/NetworkingContentDelivery/Route53.puml
!include AWSPuml/ManagementGovernance/CloudWatch.puml

skinparam linetype ortho
skinparam defaultTextAlignment center
skinparam nodesep 140
skinparam ranksep 70

top to bottom direction

title Bible On Site - AWS Architecture (il-central-1)

actor "Internet User" as user
Client(browser, "Browser", "Web Client")
Mobileclient(mobileApp, "Mobile App", "iOS/Android")
actor "GitHub Actions CD" as cd

rectangle "AWS Cloud (il-central-1)" as aws {

    Route53(route53, "Route53", "DNS Zones")
    rectangle "VPC (172.31.0.0/16)" as vpc {

        rectangle "Public Subnet" as publicSubnet {
            EC2(nginx, "EC2: Nginx", "Reverse Proxy | SSL Termination")
        }

        CloudMap(cloudmap, "Cloud Map", "bible-on-site.local")

        rectangle "ECS Fargate Cluster" as ecs {
            ElasticContainerService(website, "Website Service", "Port 3000")
            ElasticContainerService(api, "API Service", "Port 3003")
        }

        CloudWatch(cloudwatch, "CloudWatch", "Container Logs")
    }

    rectangle "Container Registry" as registry {
        ElasticContainerRegistry(ecr, "ECR", "bible-on-site\nbible-on-site-api")
    }

    rectangle "Auto Deploy" as autoDeploy {
        EventBridge(eventbridge, "EventBridge", "ECR Push Rule")
        Lambda(lambda, "Lambda", "ecr-to-ecs-deploy")
    }
}

' User Data Flow
user -down-> browser
user -down-> mobileApp
browser -down-> route53 : xn--febl3a.[co.il,com]
mobileApp -down-> route53 : api.xn--febl3a.[co.il,com]
route53 -down--> nginx : A Record
nginx -down--> cloudmap : 1. Resolve ECS Tasks
cloudmap .right..> nginx : Return Task IPs
nginx -down-> website
note right of link : 2. Proxy xn--febl3a.[co.il,com] Traffic
nginx -down-> api
note right of link : 2. Proxy api.xn--febl3a.[co.il,com] Traffic

' CD Deployment Flow
cd -down---> ecr : Push Image\n(OIDC Auth)
ecr -down-> ecs : Pull Images

' Auto Deploy Flow
eventbridge .left..> ecr : Listens to\nPush Events
eventbridge -down-> lambda : Trigger
lambda -left-> ecs
note bottom of link : Load Latest Image from ECR

ecs -left--> cloudwatch : Scale In/Out
ecs -down--> cloudwatch : Logs
@enduml
