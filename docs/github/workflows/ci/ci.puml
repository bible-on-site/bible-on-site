@startuml CI Workflow
!theme plain
skinparam backgroundColor #FEFEFE
skinparam ActivityBackgroundColor #E8F4FD
skinparam ActivityBorderColor #2196F3
skinparam ActivityFontColor #1565C0
skinparam ArrowColor #1976D2
skinparam ActivityBarColor #1976D2

title Continuous Integration Workflow (ci.yml)

|#E8F4FD|Setup|
start

fork
  :Setup Environment Variables;
fork again
  :Determine Baseline Availability;
  note right
    Check & download master
    coverage artifacts (cross-wf)
    Re-upload for current run
  end note
fork again
  :Build LCOV Docker Image;
end fork

|#FFF8E1|Change Detection|
fork
  :Determine Website Changes;
fork again
  :Determine API Changes;
fork again
  :Determine App Changes;
fork again
  :Determine Data Changes;
end fork

|#E8F5E9|Module CI (Conditional)|
note
  Each runs if:
  module changed OR ci changed OR
  baseline unavailable
end note

fork
  :Website CI;
  note right: Lint, Unit, E2E
fork again
  :Website Performance;
  note right: Lighthouse
fork again
  :API CI;
  note right: Lint, E2E
fork again
  :App CI;
  note right: Lint, Unit, Integration
fork again
  :Data CI;
  note right: Lint, Unit
end fork

|#F3E5F5|Cross Module CI|
:Restore Coverage Reports;
note right
  From module CI (wf artifact)
  OR from baseline (master artifact)
end note
:Publish to Codecov & Codacy;

|#FFEBEE|Package (Master Only)|
fork
  :Package Website;
  note right: Docker image
fork again
  :Package API;
  note right: Docker image
fork again
  :Package App (app-package.yml);
  note right: MSIX + AAB parallel
end fork

|#E3F2FD|Release (Master Only)|
fork
  :Release Website;
  note right
    Tag, GitHub Release
    Trigger deploy-aws
  end note
fork again
  :Release API;
  note right
    Tag, GitHub Release
    Trigger deploy-aws
  end note
fork again
  :Release App;
  note right
    Tag, GitHub Release
    Trigger deploy-app
  end note
fork again
  :Release Data;
  note right
    Trigger deploy-data
  end note
end fork

stop

@enduml

